<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Runner 3D - Monolithic</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
        }

        #root {
            width: 100vw;
            height: 100vh;
        }

        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 10;
        }

        .score-board {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 0 10px #00f2ff;
        }

        .menu-card {
            background: rgba(0, 0, 0, 0.85);
            padding: 40px;
            border-radius: 15px;
            border: 2px solid #ff0055;
            text-align: center;
            pointer-events: auto;
            box-shadow: 0 0 30px rgba(255, 0, 85, 0.4);
        }

        button {
            background: #ff0055;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 20px;
        }

        button:hover {
            background: #ff3377;
            transform: scale(1.05);
            box-shadow: 0 0 15px #ff0055;
        }

        h1 {
            margin: 0 0 20px 0;
            font-size: 48px;
            background: linear-gradient(45deg, #ff0055, #00f2ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "three": "https://esm.sh/three@0.150.0",
        "@react-three/fiber": "https://esm.sh/@react-three/fiber@8.13.0?external=three",
        "@react-three/drei": "https://esm.sh/@react-three/drei@9.56.0?external=three"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import ReactDOM from 'react-dom';
        import * as THREE from 'three';
        import { Canvas, useFrame } from '@react-three/fiber';
        import { Stars, Text, Float } from '@react-three/drei';

        // Configuração de cores e constantes
        const PLAYER_SPEED = 0.15;
        const OBSTACLE_SPEED = 0.25;
        const SPAWN_INTERVAL = 40; // frames

        function Player({ position }) {
            const mesh = useRef();
            
            useFrame(() => {
                if (mesh.current) {
                    mesh.current.position.x = THREE.MathUtils.lerp(
                        mesh.current.position.x,
                        position.x,
                        0.1
                    );
                }
            });

            return (
                <mesh ref={mesh} position={[0, 0.5, 0]}>
                    <boxGeometry args={[1, 1, 1]} />
                    <meshStandardMaterial 
                        emissive="#00f2ff" 
                        emissiveIntensity={2} 
                        color="#00f2ff" 
                    />
                    <pointLight color="#00f2ff" intensity={1} distance={5} />
                </mesh>
            );
        }

        function Obstacle({ position, onHit }) {
            const mesh = useRef();
            
            useFrame(() => {
                if (mesh.current) {
                    mesh.current.position.z += OBSTACLE_SPEED;
                    if (mesh.current.position.z > 5) {
                        onHit(mesh.current.id);
                    }
                }
            });

            return (
                <mesh ref={mesh} position={position}>
                    <boxGeometry args={[1.5, 1.5, 1.5]} />
                    <meshStandardMaterial 
                        emissive="#ff0055" 
                        emissiveIntensity={1.5} 
                        color="#ff0055" 
                    />
                </mesh>
            );
        }

        function Road() {
            return (
                <group>
                    <gridHelper args={[100, 50, 0x444444, 0x222222]} position={[0, 0, 0]} />
                    <mesh rotation={[-Math.PI / 2, 0, 0]} position={[0, -0.1, 0]}>
                        <planeGeometry args={[10, 1000]} />
                        <meshStandardMaterial color="#050505" />
                    </mesh>
                </group>
            );
        }

        function Game({ gameState, setGameState, onGameEnd, score, setScore }) {
            const [playerPosition, setPlayerPosition] = useState({ x: 0 });
            const [obstacles, setObstacles] = useState([]);
            const frameCount = useRef(0);
            const scoreRef = useRef(0);

            // Controle de entrada
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (gameState !== 'PLAYING') return;
                    if (e.key === 'ArrowLeft' || e.key === 'a') setPlayerPosition(p => ({ x: Math.max(p.x - 2, -4) }));
                    if (e.key === 'ArrowRight' || e.key === 'd') setPlayerPosition(p => ({ x: Math.min(p.x + 2, 4) }));
                };

                const handleMouseMove = (e) => {
                    if (gameState !== 'PLAYING') return;
                    const x = (e.clientX / window.innerWidth) * 10 - 5;
                    setPlayerPosition({ x: Math.max(Math.min(x, 4), -4) });
                };

                window.addEventListener('keydown', handleKeyDown);
                window.addEventListener('mousemove', handleMouseMove);
                return () => {
                    window.removeEventListener('keydown', handleKeyDown);
                    window.removeEventListener('mousemove', handleMouseMove);
                };
            }, [gameState]);

            // Reset game state when starting
            useEffect(() => {
                if (gameState === 'PLAYING') {
                    setScore(0);
                    scoreRef.current = 0;
                    setObstacles([]);
                    setPlayerPosition({ x: 0 });
                    frameCount.current = 0;
                }
            }, [gameState]);

            // Game Loop
            useFrame(() => {
                if (gameState !== 'PLAYING') return;

                frameCount.current++;
                scoreRef.current += 1;
                if (frameCount.current % 10 === 0) {
                    setScore(Math.floor(scoreRef.current / 10));
                }

                // Spawn de obstáculos
                if (frameCount.current % SPAWN_INTERVAL === 0) {
                    const newX = (Math.random() - 0.5) * 8;
                    setObstacles(prev => [...prev, { id: Date.now(), x: newX, z: -50 }]);
                }
            });

            const triggerGameOver = () => {
                const finalScoreValue = Math.floor(scoreRef.current / 10);
                setGameState('GAME_OVER');
                // INTEGRAÇÃO REQUERIDA: Disparo de evento para o pai
                window.parent.postMessage({ type: 'GAME_OVER', score: finalScoreValue }, '*');
                onGameEnd(finalScoreValue);
            };

            const removeObstacle = (id) => {
                setObstacles(prev => prev.filter(o => o.id !== id));
            };

            return (
                <>
                    <Stars radius={100} depth={50} count={5000} factor={4} saturation={0} fade speed={1} />
                    <ambientLight intensity={0.5} />
                    <pointLight position={[10, 10, 10]} intensity={1} />
                    
                    <Road />
                    
                    <Player position={playerPosition} />

                    {obstacles.map(obs => (
                        <Obstacle 
                            key={obs.id} 
                            position={[obs.x, 0.75, obs.z]} 
                            onHit={(id) => {
                                // Checa colisão quando o obstáculo passa pelo player (z=0)
                                if (Math.abs(obs.x - playerPosition.x) < 1.3) {
                                    triggerGameOver();
                                }
                                removeObstacle(id);
                            }}
                        />
                    ))}

                    <fog attach="fog" args={['#050505', 10, 45]} />
                </>
            );
        }

        function App() {
            const [gameState, setGameState] = useState('START');
            const [score, setScore] = useState(0);
            const [finalScore, setFinalScore] = useState(0);

            const handleGameEnd = (s) => {
                setFinalScore(s);
            };

            return (
                <div style={{ width: '100%', height: '100%' }}>
                    <Canvas camera={{ position: [0, 5, 10], fov: 60 }}>
                        <Game 
                            gameState={gameState} 
                            setGameState={setGameState} 
                            onGameEnd={handleGameEnd}
                            score={score}
                            setScore={setScore}
                        />
                    </Canvas>

                    <div className="ui-overlay">
                        {gameState === 'START' && (
                            <div className="menu-card">
                                <h1>NEON RUNNER</h1>
                                <p>Use A/D ou Mouse para desviar dos cubos vermelhos</p>
                                <button onClick={() => setGameState('PLAYING')}>Iniciar Jogo</button>
                            </div>
                        )}

                        {gameState === 'GAME_OVER' && (
                            <div className="menu-card">
                                <h1 style={{ color: '#ff0055' }}>FIM DE JOGO</h1>
                                <p>Sua pontuação final:</p>
                                <h2 style={{ fontSize: '40px', margin: '10px 0' }}>{finalScore}</h2>
                                <button onClick={() => setGameState('PLAYING')}>Tentar Novamente</button>
                            </div>
                        )}

                        {gameState === 'PLAYING' && (
                            <div className="score-board">
                                SCORE: {score}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>
</html>
