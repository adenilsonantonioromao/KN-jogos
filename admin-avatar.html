<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Avatar Studio (Offline)</title>
    <style>
        body { 
            background: #1e1e1e; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; 
            margin: 0; height: 100vh; display: flex; flex-direction: column; 
            user-select: none;
        }

        header {
            background: #2d2d2d; padding: 10px 20px; border-bottom: 1px solid #444;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        h2 { margin: 0; color: #FF5722; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        
        .btn {
            border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; gap: 5px; transition: 0.2s; font-size: 0.9rem;
        }
        .btn-save { background: #4CAF50; color: white; }
        .btn-save:hover { background: #43A047; }
        .btn-load { background: #FF9800; color: white; }
        
        .btn-anim { background: #673AB7; color: white; width: 100px; justify-content: center; }
        .btn-anim.playing { background: #F44336; }

        .workspace { display: flex; flex: 1; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 240px; background: #252526; border-right: 1px solid #444; overflow-y: auto; padding: 10px; }
        .part-row { display: flex; align-items: center; gap: 5px; margin-bottom: 4px; }
        .part-btn { flex: 1; padding: 8px; background: #333; border: 1px solid #444; color: #aaa; text-align: left; cursor: pointer; border-radius: 4px; font-size: 0.85rem; }
        .part-btn.active { background: #007ACC; color: white; font-weight: bold; border-color: #007ACC; }
        .eye-btn { width: 30px; height: 32px; background: #333; border: 1px solid #444; color: #aaa; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .eye-btn.hidden { color: #555; text-decoration: line-through; }

        /* VIEWPORT (VISUAL DO JOGO) */
        .viewport { flex: 1; background: #111; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #editorCanvas { 
            background: linear-gradient(to bottom, #81D4FA, #B2EBF2); /* C√©u */
            border: 2px solid #fff; 
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5); 
        }

        /* INSPECTOR */
        .inspector { width: 320px; background: #252526; border-left: 1px solid #444; display: flex; flex-direction: column; padding: 15px; overflow-y: auto; }
        .panel-box { background: #333; border-radius: 8px; padding: 10px; margin-bottom: 15px; border: 1px solid #444; }
        .panel-title { font-size: 0.8rem; color: #888; margin-bottom: 8px; text-transform: uppercase; font-weight: bold; }

        /* XY PADS */
        .xy-pad-container { position: relative; width: 100%; padding-top: 100%; background: #222; border: 1px solid #555; border-radius: 4px; cursor: crosshair; overflow: hidden; }
        .xy-grid { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(#333 1px, transparent 1px), linear-gradient(90deg, #333 1px, transparent 1px); background-size: 20px 20px; background-position: center; }
        .xy-axis { position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: #444; } .xy-axis.vert { top: 0; left: 50%; width: 1px; height: 100%; }
        .xy-handle { position: absolute; width: 12px; height: 12px; background: #2196F3; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); top: 50%; left: 50%; pointer-events: none; }
        .val-display { display: flex; justify-content: space-between; margin-top: 5px; font-family: monospace; font-size: 0.9rem; }
        .val-box { background: #111; padding: 2px 5px; border-radius: 3px; color: #2196F3; }

        #fileInput { display: none; }
    </style>
</head>
<body>

    <header>
        <h2>üõ†Ô∏è Avatar Studio</h2>
        
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn btn-anim" id="btnAnim" onclick="toggleAnimation()">‚ñ∂ ANIMAR</button>
            
            <div style="width:20px;"></div> <!-- Separador -->

            <button class="btn btn-load" onclick="document.getElementById('fileInput').click()">üìÇ CARREGAR</button>
            <input type="file" id="fileInput" accept=".json" onchange="carregarArquivo(this)">
            
            <button class="btn btn-save" onclick="salvarArquivo()">üíæ SALVAR DADOS</button>
        </div>
    </header>

    <div class="workspace">
        <!-- LISTA -->
        <div class="sidebar" id="partsList"></div>
        
        <!-- CANVAS (Tamanho fixo simulando mobile) -->
        <div class="viewport"><canvas id="editorCanvas" width="400" height="600"></canvas></div>

        <!-- CONTROLES -->
        <div class="inspector">
            <h3 id="selectedPartName" style="margin-top:0; color:#2196F3; text-align:center;">TRONCO</h3>

            <div class="panel-box">
                <div class="panel-title">üìç Posi√ß√£o (Offset)</div>
                <div class="xy-pad-container" id="padPos">
                    <div class="xy-grid"></div><div class="xy-axis"></div><div class="xy-axis vert"></div><div class="xy-handle" id="handlePos"></div>
                </div>
                <div class="val-display">
                    <span>X: <span id="valX" class="val-box">0</span></span>
                    <span>Y: <span id="valY" class="val-box">0</span></span>
                </div>
            </div>

            <div class="panel-box">
                <div class="panel-title">üéØ Piv√¥ (Rota√ß√£o)</div>
                <div class="xy-pad-container" id="padPiv">
                    <div class="xy-grid" style="background-size: 10px 10px; opacity: 0.3;"></div><div class="xy-handle" id="handlePiv" style="background: #FF5722;"></div>
                </div>
                <div class="val-display">
                    <span>PX: <span id="valPivX" class="val-box">0.5</span></span>
                    <span>PY: <span id="valPivY" class="val-box">0.5</span></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DADOS ---
        let activePart = 'tronco';
        let isAnimating = false;
        let animTime = 0;
        let hiddenParts = {}; 
        const images = {};
        const BASE_URL = 'assets/avatar/base/';

        // --- ORDEM DE CAMADAS ---
        const LAYER_ORDER = [
            'capa', 'escudo_tras', 'braco_tras', 'perna_tras', 'perna_frente',
            'tronco', 'cintura', 'cabeca', 'rosto', 'mascara', 'cabelo',
            'arma_frente', 'braco_frente', 'escudo_frente'
        ];

        // --- MAPA DE ARQUIVOS ---
        const FILE_NAMES = {
            'capa': 'capa_simples.png',
            'escudo_tras': 'escudo_simples_tras.png',
            'braco_tras': 'braco_tras_padrao.png',
            'perna_tras': 'perna_tras_padrao.png',
            'perna_frente': 'perna_frente_padrao.png',
            'tronco': 'tronco_padrao.png',
            'cintura': 'espada_bainha_simples.png',
            'cabeca': 'cabeca_padrao.png',
            'rosto': 'rosto_padrao.png',
            'mascara': 'mascara_simples.png',
            'cabelo': 'cabelo_simples.png',
            'arma_frente': 'Espada_simples.png',
            'braco_frente': 'braco_frente_padrao.png',
            'escudo_frente': 'escudo_simples.png'
        };

        // --- CONFIG INICIAL ---
        let avatarConfig = { scale: 0.22, parts: {} };
        LAYER_ORDER.forEach(k => { avatarConfig.parts[k] = { x: 0, y: 0, pivX: 0.5, pivY: 0.5 }; });

        // --- INICIALIZA√á√ÉO ---
        function init() {
            createSidebar();
            loadImages();
            setupPads();
            loop();
        }

        // --- GERENCIAMENTO DE ARQUIVOS (SALVAR/CARREGAR) ---
        window.salvarArquivo = function() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(avatarConfig, null, 4));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "avatar_config.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        window.carregarArquivo = function(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loaded = JSON.parse(e.target.result);
                    if(loaded.parts) {
                        avatarConfig = loaded;
                        alert("‚úÖ Configura√ß√£o carregada!");
                        selectPart('tronco'); // Atualiza UI
                    } else {
                        alert("‚ùå Arquivo inv√°lido. Falta 'parts'.");
                    }
                } catch(err) {
                    alert("‚ùå Erro ao ler JSON: " + err.message);
                }
            };
            reader.readAsText(file);
            input.value = ""; 
        }

        // --- UI E PADS ---
        function createSidebar() {
            const list = document.getElementById('partsList');
            list.innerHTML = '';
            LAYER_ORDER.forEach((key, index) => {
                const row = document.createElement('div');
                row.className = 'part-row';

                const btn = document.createElement('div');
                btn.className = 'part-btn';
                btn.id = `btn-${key}`;
                btn.innerText = `${index}. ${key.toUpperCase().replace('_', ' ')}`;
                btn.onclick = () => selectPart(key);
                
                const eye = document.createElement('div');
                eye.className = 'eye-btn';
                eye.innerHTML = 'üëÅÔ∏è';
                eye.onclick = () => toggleVisibility(key, eye);

                row.appendChild(btn);
                row.appendChild(eye);
                list.appendChild(row);
            });
            selectPart('tronco');
        }

        function toggleVisibility(key, btn) {
            if (hiddenParts[key]) {
                delete hiddenParts[key];
                btn.innerHTML = 'üëÅÔ∏è';
                btn.classList.remove('hidden');
            } else {
                hiddenParts[key] = true;
                btn.innerHTML = '‚ùå';
                btn.classList.add('hidden');
            }
        }

        function loadImages() {
            LAYER_ORDER.forEach(layerName => {
                const img = new Image();
                const fileName = FILE_NAMES[layerName] || (layerName + ".png");
                img.src = `${BASE_URL}${fileName}`;
                img.onerror = () => img.isMissing = true;
                images[layerName] = img;
            });
        }

        function selectPart(key) {
            activePart = key;
            document.querySelectorAll('.part-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${key}`).classList.add('active');
            document.getElementById('selectedPartName').innerText = key.toUpperCase().replace('_', ' ');
            updatePadsUI();
        }

        // --- L√ìGICA DOS PADS (JOYSTICKS) ---
        function setupPads() {
            setupDraggable('padPos', (rx, ry) => {
                const x = Math.round((rx - 0.5) * 400); // -200 a 200
                const y = Math.round((ry - 0.5) * 600); // -300 a 300
                avatarConfig.parts[activePart].x = x;
                avatarConfig.parts[activePart].y = y;
                document.getElementById('valX').innerText = x;
                document.getElementById('valY').innerText = y;
                updatePadsUI(true);
            });

            setupDraggable('padPiv', (rx, ry) => {
                avatarConfig.parts[activePart].pivX = parseFloat(rx.toFixed(3));
                avatarConfig.parts[activePart].pivY = parseFloat(ry.toFixed(3));
                document.getElementById('valPivX').innerText = rx.toFixed(2);
                document.getElementById('valPivY').innerText = ry.toFixed(2);
                updatePadsUI(true);
            });
        }

        function setupDraggable(id, callback) {
            const el = document.getElementById(id);
            let isDragging = false;
            const update = (e) => {
                const rect = el.getBoundingClientRect();
                let x = (e.clientX - rect.left) / rect.width;
                let y = (e.clientY - rect.top) / rect.height;
                x = Math.max(0, Math.min(1, x));
                y = Math.max(0, Math.min(1, y));
                callback(x, y);
            };
            el.addEventListener('mousedown', (e) => { isDragging = true; update(e); });
            window.addEventListener('mousemove', (e) => { if(isDragging) update(e); });
            window.addEventListener('mouseup', () => isDragging = false);
        }

        function updatePadsUI(skipLogic) {
            const cfg = avatarConfig.parts[activePart];
            if(!skipLogic) {
                document.getElementById('valX').innerText = cfg.x;
                document.getElementById('valY').innerText = cfg.y;
                document.getElementById('valPivX').innerText = cfg.pivX;
                document.getElementById('valPivY').innerText = cfg.pivY;
            }
            const rx = (cfg.x / 400) + 0.5;
            const ry = (cfg.y / 600) + 0.5;
            document.getElementById('handlePos').style.left = (rx * 100) + '%';
            document.getElementById('handlePos').style.top = (ry * 100) + '%';
            document.getElementById('handlePiv').style.left = (cfg.pivX * 100) + '%';
            document.getElementById('handlePiv').style.top = (cfg.pivY * 100) + '%';
        }

        window.toggleAnimation = function() {
            isAnimating = !isAnimating;
            const btn = document.getElementById('btnAnim');
            if(isAnimating) { btn.innerText = "‚èπ STOP"; btn.classList.add('playing'); } 
            else { btn.innerText = "‚ñ∂ ANIMAR"; btn.classList.remove('playing'); animTime = 0; }
        }

        // --- RENDERIZA√á√ÉO ---
        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d');

        function loop() {
            const w = canvas.width; const h = canvas.height;
            ctx.clearRect(0, 0, w, h);

            // CEN√ÅRIO IDENTICO AO JOGO
            // Ch√£o fixo 150px da borda inferior (como voc√™ pediu)
            const groundY = h - 150;
            const centerX = w / 2;

            ctx.save();
            // Fundo Grama
            ctx.fillStyle = '#81C784'; ctx.beginPath(); ctx.ellipse(centerX, groundY+60, w*0.9, 100, 0, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#4CAF50'; ctx.lineWidth = 10; ctx.stroke();

            // POSICIONA BONECO
            ctx.translate(centerX, groundY);
            // Aplica escala do jogo (0.22)
            const s = (avatarConfig.scale || 0.22);
            
            if (isAnimating) animTime += 0.1; else animTime = 0;
            const walk = Math.sin(animTime);
            const bob = Math.abs(Math.sin(animTime)) * 10;
            const breathe = Math.sin(animTime * 0.5) * 0.05;

            LAYER_ORDER.forEach(key => {
                if (hiddenParts[key]) return;
                const img = images[key];
                const cfg = avatarConfig.parts[key];

                if (!img || img.isMissing) {
                    // Placeholder apenas para partes cr√≠ticas
                    if(['tronco','cabeca'].includes(key)) {
                        ctx.save(); ctx.translate(cfg.x*s, cfg.y*s); 
                        ctx.fillStyle='rgba(255,255,255,0.3)'; ctx.fillRect(-10,-10,20,20); 
                        ctx.restore();
                    }
                    return; 
                }

                let animX = 0, animY = 0, animRot = 0;
                
                if (isAnimating) {
                     if (key === 'arma_frente' || key === 'escudo_frente') {
                        const parent = avatarConfig.parts['braco_frente'];
                        const pRot = -walk * 0.6;
                        const relX = (cfg.x - parent.x)*s; const relY = (cfg.y - parent.y)*s;
                        const rotX = relX * Math.cos(pRot) - relY * Math.sin(pRot);
                        const rotY = relX * Math.sin(pRot) + relY * Math.cos(pRot);
                        
                        ctx.save();
                        ctx.translate((parent.x*s) + rotX, ((parent.y*s) - (bob*s) + rotY));
                        ctx.rotate(pRot);
                        ctx.drawImage(img, -img.width * s * cfg.pivX, -img.height * s * cfg.pivY, img.width*s, img.height*s);
                        if(key === activePart) desenhaGizmo(ctx, img, s, cfg);
                        ctx.restore();
                        return;
                    }
                    if (key === 'escudo_tras') {
                        const parent = avatarConfig.parts['braco_tras'];
                        const pRot = walk * 0.6;
                        const relX = (cfg.x - parent.x)*s; const relY = (cfg.y - parent.y)*s;
                        const rotX = relX * Math.cos(pRot) - relY * Math.sin(pRot);
                        const rotY = relX * Math.sin(pRot) + relY * Math.cos(pRot);
                        
                        ctx.save();
                        ctx.translate((parent.x*s) + rotX, ((parent.y*s) - (bob*s) + rotY));
                        ctx.rotate(pRot);
                        ctx.filter = "brightness(0.7)";
                        ctx.drawImage(img, -img.width * s * cfg.pivX, -img.height * s * cfg.pivY, img.width*s, img.height*s);
                        ctx.filter = "none";
                        if(key === activePart) desenhaGizmo(ctx, img, s, cfg);
                        ctx.restore();
                        return;
                    }

                    if (key.includes('perna')) { animY = -bob; animRot = (key.includes('frente') ? walk : -walk) * 0.5; }
                    else if (key.includes('braco')) { animY = -bob; animRot = (key.includes('frente') ? -walk : walk) * 0.6; }
                    else if (['cabeca', 'rosto', 'mascara', 'cabelo'].includes(key)) { animY = -bob + (breathe * 5); animRot = breathe * 0.2; }
                    else { animY = -bob; }
                }

                ctx.save();
                ctx.translate((cfg.x*s) + (animX*s), (cfg.y*s) + (animY*s));
                ctx.rotate(animRot);
                if (key.includes('tras') || key === 'capa') ctx.filter = "brightness(0.7)";
                
                ctx.drawImage(img, -img.width * s * cfg.pivX, -img.height * s * cfg.pivY, img.width * s, img.height * s);
                ctx.filter = "none";
                
                if (key === activePart) desenhaGizmo(ctx, img, s, cfg);
                
                ctx.restore();
            });

            ctx.restore();
            requestAnimationFrame(loop);
        }

        function desenhaGizmo(ctx, img, s, cfg) {
            const w = img.width * s;
            const h = img.height * s;
            ctx.fillStyle = '#FF5722'; ctx.beginPath(); ctx.arc(0,0, 4, 0, Math.PI*2); ctx.fill(); // Piv√¥
            ctx.strokeStyle = '#FFC107'; ctx.lineWidth = 2;
            ctx.strokeRect(-w * cfg.pivX, -h * cfg.pivY, w, h); // Box
        }

        init();
    </script>
</body>
</html>
