<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Avatar Studio (Visual Jogo)</title>
    <style>
        body { 
            background: #1e1e1e; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; 
            margin: 0; height: 100vh; display: flex; flex-direction: column; 
            user-select: none;
        }

        /* HEADER */
        header {
            background: #2d2d2d; padding: 10px 20px; border-bottom: 1px solid #444;
            display: flex; justify-content: space-between; align-items: center;
        }
        h2 { margin: 0; color: #FF5722; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        
        .btn {
            border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; gap: 5px; transition: 0.2s; font-size: 0.9rem;
        }
        .btn-save { background: #4CAF50; color: white; }
        .btn-save:hover { background: #43A047; }
        .btn-load { background: #FF9800; color: white; }
        .btn-copy { background: #2196F3; color: white; }
        
        .btn-anim { background: #673AB7; color: white; width: 100px; justify-content: center; }
        .btn-anim.playing { background: #F44336; }

        .workspace { display: flex; flex: 1; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 240px; background: #252526; border-right: 1px solid #444; overflow-y: auto; padding: 10px; }
        .part-row { display: flex; align-items: center; gap: 5px; margin-bottom: 4px; }
        .part-btn { flex: 1; padding: 8px; background: #333; border: 1px solid #444; color: #aaa; text-align: left; cursor: pointer; border-radius: 4px; font-size: 0.85rem; }
        .part-btn.active { background: #007ACC; color: white; font-weight: bold; border-color: #007ACC; }
        .eye-btn { width: 30px; height: 32px; background: #333; border: 1px solid #444; color: #aaa; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .eye-btn.hidden { color: #555; text-decoration: line-through; }

        /* VIEWPORT (AGORA COM VISUAL DO JOGO) */
        .viewport { flex: 1; background: #111; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #editorCanvas { 
            /* Fundo Azul C√©u Igual ao Jogo */
            background: linear-gradient(to bottom, #81D4FA, #B2EBF2);
            border: 2px solid #fff; 
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5); 
        }

        /* INSPECTOR */
        .inspector { width: 320px; background: #252526; border-left: 1px solid #444; display: flex; flex-direction: column; padding: 15px; overflow-y: auto; }
        .panel-box { background: #333; border-radius: 8px; padding: 10px; margin-bottom: 15px; border: 1px solid #444; }
        .panel-title { font-size: 0.8rem; color: #888; margin-bottom: 8px; text-transform: uppercase; font-weight: bold; }

        /* XY PADS */
        .xy-pad-container { position: relative; width: 100%; padding-top: 100%; background: #222; border: 1px solid #555; border-radius: 4px; cursor: crosshair; overflow: hidden; }
        .xy-grid { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(#333 1px, transparent 1px), linear-gradient(90deg, #333 1px, transparent 1px); background-size: 20px 20px; background-position: center; }
        .xy-axis { position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: #444; } .xy-axis.vert { top: 0; left: 50%; width: 1px; height: 100%; }
        .xy-handle { position: absolute; width: 12px; height: 12px; background: #2196F3; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); top: 50%; left: 50%; pointer-events: none; }
        .val-display { display: flex; justify-content: space-between; margin-top: 5px; font-family: monospace; font-size: 0.9rem; }
        .val-box { background: #111; padding: 2px 5px; border-radius: 3px; color: #2196F3; }

        #fileInput { display: none; }
    </style>
</head>
<body>

    <header>
        <h2>üõ†Ô∏è Avatar Studio</h2>
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn btn-anim" id="btnAnim" onclick="toggleAnimation()">‚ñ∂ PLAY</button>
            <span style="font-size:0.8rem; color:#aaa;">Zoom:</span>
            <input type="range" min="0.5" max="3" step="0.1" value="1" oninput="updateZoom(this.value)">
            <div style="width:20px;"></div>
            <button class="btn btn-load" onclick="document.getElementById('fileInput').click()">üìÇ ABRIR</button>
            <input type="file" id="fileInput" accept=".json" onchange="carregarArquivo(this)">
            <button class="btn btn-copy" onclick="copiarJSON()">üìã COPIAR</button>
            <button class="btn btn-save" onclick="salvarArquivo()">üíæ SALVAR</button>
        </div>
    </header>

    <div class="workspace">
        <div class="sidebar" id="partsList"></div>
        <!-- Canvas com tamanho fixo simulando mobile/PC -->
        <div class="viewport"><canvas id="editorCanvas" width="400" height="600"></canvas></div>

        <div class="inspector">
            <h3 id="selectedPartName" style="margin-top:0; color:#2196F3; text-align:center;">TRONCO</h3>

            <div class="panel-box">
                <div class="panel-title">üìç Posi√ß√£o (Offset)</div>
                <div class="xy-pad-container" id="padPos">
                    <div class="xy-grid"></div><div class="xy-axis"></div><div class="xy-axis vert"></div><div class="xy-handle" id="handlePos"></div>
                </div>
                <div class="val-display">
                    <span>X: <span id="valX" class="val-box">0</span></span>
                    <span>Y: <span id="valY" class="val-box">0</span></span>
                </div>
            </div>

            <div class="panel-box">
                <div class="panel-title">üéØ Piv√¥ (Rota√ß√£o)</div>
                <div class="xy-pad-container" id="padPiv">
                    <div class="xy-grid" style="background-size: 10px 10px; opacity: 0.3;"></div><div class="xy-handle" id="handlePiv" style="background: #FF5722;"></div>
                </div>
                <div class="val-display">
                    <span>PX: <span id="valPivX" class="val-box">0.5</span></span>
                    <span>PY: <span id="valPivY" class="val-box">0.5</span></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DADOS ---
        let viewportZoom = 1.0;
        let activePart = 'tronco';
        let isAnimating = false;
        let animTime = 0;
        let hiddenParts = {}; 
        const images = {};
        const BASE_URL = 'assets/avatar/base/';

        // ORDEM EXATA (14 ITENS)
        const LAYER_ORDER = [
            'capa', 'escudo_tras', 'braco_tras', 'perna_tras', 'perna_frente',
            'tronco', 'cintura', 'cabeca', 'rosto', 'mascara', 'cabelo',
            'arma_frente', 'braco_frente', 'escudo_frente'
        ];

        // Mapeia nomes caso estejam diferentes
        const FILE_NAMES = {
            'capa': 'capa_simples.png',
            'escudo_tras': 'escudo_simples_tras.png',
            'braco_tras': 'braco_tras_padrao.png',
            'perna_tras': 'perna_tras_padrao.png',
            'perna_frente': 'perna_frente_padrao.png',
            'tronco': 'tronco_padrao.png',
            'cintura': 'espada_bainha_simples.png',
            'cabeca': 'cabeca_padrao.png',
            'rosto': 'rosto_padrao.png',
            'mascara': 'mascara_simples.png',
            'cabelo': 'cabelo_simples.png',
            'arma_frente': 'Espada_simples.png',
            'braco_frente': 'braco_frente_padrao.png',
            'escudo_frente': 'escudo_simples.png'
        };

        // --- CONFIG INICIAL ---
        let avatarConfig = { scale: 0.22, parts: {} };
        LAYER_ORDER.forEach(k => { avatarConfig.parts[k] = { x: 0, y: 0, pivX: 0.5, pivY: 0.5 }; });

        // --- INICIALIZA√á√ÉO ---
        function init() {
            createSidebar();
            loadImages();
            setupPads();
            loop();
        }

        // --- SALVAR/CARREGAR ARQUIVO JSON ---
        window.salvarArquivo = function() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(avatarConfig, null, 4));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "avatar_config.json");
            document.body.appendChild(node);
            node.click();
            node.remove();
        }

        window.copiarJSON = function() {
            navigator.clipboard.writeText(JSON.stringify(avatarConfig, null, 4)).then(() => alert("‚úÖ JSON copiado!"));
        }

        window.carregarArquivo = function(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loaded = JSON.parse(e.target.result);
                    if(loaded.parts) {
                        avatarConfig = loaded;
                        alert("‚úÖ Config carregada!");
                        selectPart('tronco');
                    } else alert("‚ùå JSON inv√°lido");
                } catch(err) { alert("‚ùå Erro arquivo"); }
            };
            reader.readAsText(file);
            input.value = "";
        }

        // --- UI E PADS ---
        function createSidebar() {
            const list = document.getElementById('partsList'); list.innerHTML = '';
            LAYER_ORDER.forEach((key, index) => {
                const row = document.createElement('div'); row.className = 'part-row';
                const btn = document.createElement('div'); btn.className = 'part-btn';
                btn.id = `btn-${key}`; btn.innerText = `${index}. ${key.toUpperCase().replace('_', ' ')}`;
                btn.onclick = () => selectPart(key);
                const eye = document.createElement('div'); eye.className = 'eye-btn'; eye.innerHTML = 'üëÅÔ∏è';
                eye.onclick = () => toggleVisibility(key, eye);
                row.appendChild(btn); row.appendChild(eye); list.appendChild(row);
            });
            selectPart('tronco');
        }

        function toggleVisibility(key, btn) {
            if (hiddenParts[key]) { delete hiddenParts[key]; btn.innerHTML = 'üëÅÔ∏è'; btn.classList.remove('hidden'); } 
            else { hiddenParts[key] = true; btn.innerHTML = '‚ùå'; btn.classList.add('hidden'); }
        }

        function loadImages() {
            LAYER_ORDER.forEach(layerName => {
                const img = new Image();
                const fileName = FILE_NAMES[layerName] || (layerName + ".png");
                img.src = `${BASE_URL}${fileName}`;
                img.onerror = () => img.isMissing = true;
                images[layerName] = img;
            });
        }

        function selectPart(key) {
            activePart = key;
            document.querySelectorAll('.part-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${key}`).classList.add('active');
            document.getElementById('selectedPartName').innerText = key.toUpperCase().replace('_', ' ');
            updatePadsUI();
        }

        function setupPads() {
            setupDraggable('padPos', (rx, ry) => {
                const x = Math.round((rx - 0.5) * 400); // Range +/- 200
                const y = Math.round((ry - 0.5) * 600); // Range +/- 300
                avatarConfig.parts[activePart].x = x;
                avatarConfig.parts[activePart].y = y;
                updatePadsUI(true);
            });
            setupDraggable('padPiv', (rx, ry) => {
                avatarConfig.parts[activePart].pivX = parseFloat(rx.toFixed(3));
                avatarConfig.parts[activePart].pivY = parseFloat(ry.toFixed(3));
                updatePadsUI(true);
            });
        }

        function setupDraggable(id, callback) {
            const el = document.getElementById(id);
            let isDragging = false;
            const update = (e) => {
                const rect = el.getBoundingClientRect();
                let x = (e.clientX - rect.left) / rect.width;
                let y = (e.clientY - rect.top) / rect.height;
                x = Math.max(0, Math.min(1, x)); y = Math.max(0, Math.min(1, y));
                callback(x, y);
            };
            el.addEventListener('mousedown', (e) => { isDragging = true; update(e); });
            window.addEventListener('mousemove', (e) => { if(isDragging) update(e); });
            window.addEventListener('mouseup', () => isDragging = false);
        }

        function updatePadsUI(skip) {
            const cfg = avatarConfig.parts[activePart];
            if(!skip) {
                document.getElementById('valX').innerText = cfg.x; document.getElementById('valY').innerText = cfg.y;
                document.getElementById('valPivX').innerText = cfg.pivX; document.getElementById('valPivY').innerText = cfg.pivY;
            }
            const rx = (cfg.x / 400) + 0.5; const ry = (cfg.y / 600) + 0.5;
            document.getElementById('handlePos').style.left = (rx * 100) + '%';
            document.getElementById('handlePos').style.top = (ry * 100) + '%';
            document.getElementById('handlePiv').style.left = (cfg.pivX * 100) + '%';
            document.getElementById('handlePiv').style.top = (cfg.pivY * 100) + '%';
        }

        window.updateZoom = function(val) { viewportZoom = parseFloat(val); }
        window.toggleAnimation = function() {
            isAnimating = !isAnimating;
            const btn = document.getElementById('btnAnim');
            if(isAnimating) { btn.innerText = "‚èπ STOP"; btn.classList.add('playing'); } 
            else { btn.innerText = "‚ñ∂ PLAY"; btn.classList.remove('playing'); animTime = 0; }
        }

        // --- RENDERIZA√á√ÉO (SIMULANDO O JOGO) ---
        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d');

        function loop() {
            const w = canvas.width; const h = canvas.height;
            ctx.clearRect(0, 0, w, h);

            // DESENHA O CH√ÉO DE GRAMA (Igual ao jogo)
            // Centralizado na base (y=600, x=200 - note que o canvas aqui √© menor, ajustamos a propor√ß√£o)
            // No editor o centro visual √© (250, 450) para ter espa√ßo pro boneco
            const groundY = 520; 

            // C√©u j√° √© CSS. Ch√£o:
            ctx.save();
            ctx.translate(0, 0); // Reset
            ctx.fillStyle = '#81C784'; ctx.beginPath(); ctx.ellipse(w/2, groundY+60, w*0.9, 100, 0, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#4CAF50'; ctx.lineWidth = 10; ctx.stroke();
            ctx.restore();

            // Boneco
            ctx.save();
            ctx.translate(250, groundY); // Boneco no ch√£o (igual jogo)
            ctx.scale(viewportZoom, viewportZoom); 
            // ctx.scale(0.22, 0.22); // O editor usa zoom customizado, n√£o a escala do jogo, para ver detalhes

            if (isAnimating) animTime += 0.1; else animTime = 0;
            const walk = Math.sin(animTime);
            const bob = Math.abs(Math.sin(animTime)) * 10;
            const breathe = Math.sin(animTime * 0.5) * 0.05;

            LAYER_ORDER.forEach(key => {
                if (hiddenParts[key]) return;
                const img = images[key];
                const cfg = avatarConfig.parts[key];
                
                if (!img || img.isMissing) {
                    if(['tronco','cabeca'].includes(key)) {
                        ctx.save(); ctx.translate(cfg.x, cfg.y);
                        ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.fillRect(-20, -20, 40, 40); ctx.restore();
                    }
                    return;
                }

                // C√°lculo Anima√ß√£o + Parenting
                let animX = 0, animY = 0, animRot = 0;
                
                if (isAnimating) {
                    if (key === 'arma_frente' || key === 'escudo_frente') {
                        const parent = avatarConfig.parts['braco_frente'];
                        const pRot = -walk * 0.6;
                        const shoulderX = parent.x; const shoulderY = parent.y - bob;
                        const relX = cfg.x - parent.x; const relY = cfg.y - parent.y;
                        const rotX = relX * Math.cos(pRot) - relY * Math.sin(pRot); const rotY = relX * Math.sin(pRot) + relY * Math.cos(pRot);
                        ctx.save(); ctx.translate(shoulderX + rotX, shoulderY + rotY); ctx.rotate(pRot);
                        ctx.drawImage(img, -img.width * cfg.pivX, -img.height * cfg.pivY);
                        if (key === activePart) desenhaGizmo(img, cfg);
                        ctx.restore(); return;
                    }
                    if (key === 'escudo_tras') {
                        const parent = avatarConfig.parts['braco_tras'];
                        const pRot = walk * 0.6;
                        const shoulderX = parent.x; const shoulderY = parent.y - bob;
                        const relX = cfg.x - parent.x; const relY = cfg.y - parent.y;
                        const rotX = relX * Math.cos(pRot) - relY * Math.sin(pRot); const rotY = relX * Math.sin(pRot) + relY * Math.cos(pRot);
                        ctx.save(); ctx.translate(shoulderX + rotX, shoulderY + rotY); ctx.rotate(pRot);
                        ctx.filter = "brightness(0.7)";
                        ctx.drawImage(img, -img.width * cfg.pivX, -img.height * cfg.pivY);
                        ctx.filter = "none";
                        if (key === activePart) desenhaGizmo(img, cfg);
                        ctx.restore(); return;
                    }
                    if (key.includes('perna')) {
                        const isFrente = key.includes('frente'); animY = -bob; animRot = (isFrente ? walk : -walk) * 0.5;
                    } else if (key.includes('braco')) {
                        const isFrente = key.includes('frente'); animY = -bob; animRot = (isFrente ? -walk : walk) * 0.6;
                    } else if (['cabeca', 'rosto', 'mascara', 'cabelo'].includes(key)) {
                        animY = -bob + (breathe * 5); animRot = breathe * 0.2;
                    } else { animY = -bob; }
                }

                ctx.save();
                ctx.translate(cfg.x + animX, cfg.y + animY);
                ctx.rotate(animRot);
                if (key.includes('tras') || key === 'capa') ctx.filter = "brightness(0.7)";
                
                ctx.drawImage(img, -img.width * cfg.pivX, -img.height * cfg.pivY);
                ctx.filter = "none";

                if (key === activePart) desenhaGizmo(img, cfg);
                
                ctx.restore();
            });
            ctx.restore();
            requestAnimationFrame(loop);
        }

        function desenhaGizmo(img, cfg) {
            ctx.fillStyle = '#FF5722'; ctx.beginPath(); ctx.arc(0,0, 5/viewportZoom, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#FFC107'; ctx.lineWidth = 2/viewportZoom;
            ctx.strokeRect(-img.width * cfg.pivX, -img.height * cfg.pivY, img.width, img.height);
        }

        init();
    </script>
</body>
</html>
