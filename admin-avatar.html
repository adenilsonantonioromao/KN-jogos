<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Avatar Studio Pro</title>
    <style>
        body { background: #1e1e1e; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; user-select: none; }
        header { background: #2d2d2d; padding: 10px 20px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
        h2 { margin: 0; color: #FF5722; font-size: 1.1rem; }
        .btn { border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-save { background: #4CAF50; color: white; } .btn-save:hover { background: #43A047; }
        .btn-anim { background: #2196F3; color: white; width: 100px; justify-content: center; } .btn-anim.playing { background: #F44336; }
        .workspace { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 240px; background: #252526; border-right: 1px solid #444; overflow-y: auto; padding: 10px; }
        .part-row { display: flex; align-items: center; gap: 5px; margin-bottom: 4px; }
        .part-btn { flex: 1; padding: 8px; background: #333; border: 1px solid #444; color: #aaa; text-align: left; cursor: pointer; border-radius: 4px; font-size: 0.85rem; }
        .part-btn.active { background: #007ACC; color: white; font-weight: bold; border-color: #007ACC; }
        .eye-btn { width: 30px; height: 32px; background: #333; border: 1px solid #444; color: #aaa; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .eye-btn.hidden { color: #555; text-decoration: line-through; }
        .viewport { flex: 1; background: #111; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #editorCanvas { background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px; background-color: #1a1a1a; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .inspector { width: 320px; background: #252526; border-left: 1px solid #444; display: flex; flex-direction: column; padding: 15px; overflow-y: auto; }
        .panel-box { background: #333; border-radius: 8px; padding: 10px; margin-bottom: 15px; border: 1px solid #444; }
        .panel-title { font-size: 0.8rem; color: #888; margin-bottom: 8px; text-transform: uppercase; font-weight: bold; }
        .xy-pad-container { position: relative; width: 100%; padding-top: 100%; background: #222; border: 1px solid #555; border-radius: 4px; cursor: crosshair; overflow: hidden; }
        .xy-grid { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(#333 1px, transparent 1px), linear-gradient(90deg, #333 1px, transparent 1px); background-size: 20px 20px; background-position: center; }
        .xy-axis { position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: #444; } .xy-axis.vert { top: 0; left: 50%; width: 1px; height: 100%; }
        .xy-handle { position: absolute; width: 12px; height: 12px; background: #2196F3; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); top: 50%; left: 50%; pointer-events: none; }
        .val-display { display: flex; justify-content: space-between; margin-top: 5px; font-family: monospace; font-size: 0.9rem; }
        .val-box { background: #111; padding: 2px 5px; border-radius: 3px; color: #2196F3; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body>
    <div id="login-overlay"><div style="text-align:center;"><h1 style="color:white;">üîê Avatar Studio</h1><button id="btnLogin" class="btn btn-save" style="background:#2196F3; padding:15px 30px;">Entrar com Google</button></div></div>
    <header>
        <h2>üõ†Ô∏è Editor <span id="debug-uid" style="font-size:0.7rem; background:#000; padding:2px 5px; border-radius:4px;">...</span></h2>
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn btn-anim" id="btnAnim" onclick="toggleAnimation()">‚ñ∂ PLAY</button>
            <span style="font-size:0.8rem; color:#aaa;">Zoom:</span><input type="range" min="0.5" max="3" step="0.1" value="1" oninput="updateZoom(this.value)">
            <button class="btn btn-save" onclick="salvarNoFirebase()">üíæ PUBLICAR</button>
        </div>
    </header>
    <div class="workspace">
        <div class="sidebar" id="partsList"></div>
        <div class="viewport"><canvas id="editorCanvas" width="500" height="600"></canvas></div>
        <div class="inspector">
            <h3 id="selectedPartName" style="margin-top:0; color:#2196F3; text-align:center;">TRONCO</h3>
            <div class="panel-box"><div class="panel-title">üìç Posi√ß√£o (Offset)</div><div class="xy-pad-container" id="padPos"><div class="xy-grid"></div><div class="xy-axis"></div><div class="xy-axis vert"></div><div class="xy-handle" id="handlePos"></div></div><div class="val-display"><span>X: <span id="valX" class="val-box">0</span></span><span>Y: <span id="valY" class="val-box">0</span></span></div></div>
            <div class="panel-box"><div class="panel-title">üéØ Piv√¥ (Rota√ß√£o)</div><div class="xy-pad-container" id="padPiv"><div class="xy-grid" style="background-size: 10px 10px; opacity: 0.3;"></div><div class="xy-handle" id="handlePiv" style="background: #FF5722;"></div></div><div class="val-display"><span>PX: <span id="valPivX" class="val-box">0.5</span></span><span>PY: <span id="valPivY" class="val-box">0.5</span></span></div></div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js";

        const firebaseConfig = { apiKey: "AIzaSyBIR7CqYYvMZVQxtO67JCQoJ3OLT1cvAx8", authDomain: "kn-jogos.firebaseapp.com", projectId: "kn-jogos", storageBucket: "kn-jogos.firebasestorage.app", messagingSenderId: "273132829744", appId: "1:273132829744:web:a03e85b80ffabfa24101f5" };
        const app = initializeApp(firebaseConfig);
        try { const appCheck = initializeAppCheck(app, { provider: new ReCaptchaV3Provider('6Lc5vjgsAAAAANx2ia8s_Fh0_KS0_YNaAlSIYpJC'), isTokenAutoRefreshEnabled: true }); } catch(e) {}
        const auth = getAuth(app); const db = getFirestore(app); const provider = new GoogleAuthProvider();

        let viewportZoom = 1.0; let activePart = 'tronco'; let isAnimating = false; let animTime = 0; let hiddenParts = {}; const images = {}; const BASE_URL = 'assets/avatar/base/'; let MEU_UID_ATUAL = ""; 
        const LAYER_ORDER = ['capa', 'escudo_tras', 'braco_tras', 'perna_tras', 'perna_frente', 'tronco', 'cintura', 'cabeca', 'rosto', 'mascara', 'cabelo', 'arma_frente', 'braco_frente', 'escudo_frente'];
        let avatarConfig = { scale: 0.22, parts: {} };
        LAYER_ORDER.forEach(k => { avatarConfig.parts[k] = { x: 0, y: 0, pivX: 0.5, pivY: 0.5 }; });

        function init() { createSidebar(); loadImages(); loadConfigFromDb(); setupPads(); loop(); }
        async function loadConfigFromDb() {
            try { const snap = await getDoc(doc(db, "config", "avatar_base")); if (snap.exists()) { const data = snap.data(); avatarConfig.scale = data.scale || 0.22; LAYER_ORDER.forEach(k => { if(data.parts[k]) avatarConfig.parts[k] = data.parts[k]; }); selectPart('tronco'); } } catch(e) { console.log("Padr√£o."); }
        }
        function createSidebar() {
            const list = document.getElementById('partsList'); list.innerHTML = '';
            LAYER_ORDER.forEach((key, index) => {
                const row = document.createElement('div'); row.className = 'part-row';
                const btn = document.createElement('div'); btn.className = 'part-btn'; btn.id = `btn-${key}`; btn.innerText = `${index}. ${key.toUpperCase().replace('_', ' ')}`; btn.onclick = () => selectPart(key);
                const eye = document.createElement('div'); eye.className = 'eye-btn'; eye.innerHTML = 'üëÅÔ∏è'; eye.onclick = () => toggleVisibility(key, eye);
                row.appendChild(btn); row.appendChild(eye); list.appendChild(row);
            });
        }
        function toggleVisibility(key, btn) { if (hiddenParts[key]) { delete hiddenParts[key]; btn.innerHTML = 'üëÅÔ∏è'; btn.classList.remove('hidden'); } else { hiddenParts[key] = true; btn.innerHTML = '‚ùå'; btn.classList.add('hidden'); } }
        function loadImages() { LAYER_ORDER.forEach(name => { const img = new Image(); img.src = `${BASE_URL}${name}.png`; img.onerror = () => img.isMissing = true; images[name] = img; }); }
        function selectPart(key) { activePart = key; document.querySelectorAll('.part-btn').forEach(b => b.classList.remove('active')); document.getElementById(`btn-${key}`).classList.add('active'); document.getElementById('selectedPartName').innerText = key.toUpperCase().replace('_', ' '); updatePadsUI(); }
        function setupPads() {
            setupDraggable('padPos', (rx, ry) => { const x = Math.round((rx - 0.5) * 400); const y = Math.round((ry - 0.5) * 600); avatarConfig.parts[activePart].x = x; avatarConfig.parts[activePart].y = y; document.getElementById('valX').innerText = x; document.getElementById('valY').innerText = y; updatePadsUI(true); });
            setupDraggable('padPiv', (rx, ry) => { avatarConfig.parts[activePart].pivX = parseFloat(rx.toFixed(3)); avatarConfig.parts[activePart].pivY = parseFloat(ry.toFixed(3)); document.getElementById('valPivX').innerText = rx.toFixed(2); document.getElementById('valPivY').innerText = ry.toFixed(2); updatePadsUI(true); });
        }
        function setupDraggable(id, callback) {
            const el = document.getElementById(id); let isDragging = false;
            const update = (e) => { const rect = el.getBoundingClientRect(); let x = (e.clientX - rect.left) / rect.width; let y = (e.clientY - rect.top) / rect.height; x = Math.max(0, Math.min(1, x)); y = Math.max(0, Math.min(1, y)); callback(x, y); };
            el.addEventListener('mousedown', (e) => { isDragging = true; update(e); }); window.addEventListener('mousemove', (e) => { if(isDragging) update(e); }); window.addEventListener('mouseup', () => isDragging = false);
        }
        function updatePadsUI(skipLogic) {
            const cfg = avatarConfig.parts[activePart];
            if(!skipLogic) { document.getElementById('valX').innerText = cfg.x; document.getElementById('valY').innerText = cfg.y; document.getElementById('valPivX').innerText = cfg.pivX; document.getElementById('valPivY').innerText = cfg.pivY; }
            const rx = (cfg.x / 400) + 0.5; const ry = (cfg.y / 600) + 0.5;
            document.getElementById('handlePos').style.left = (rx * 100) + '%'; document.getElementById('handlePos').style.top = (ry * 100) + '%';
            document.getElementById('handlePiv').style.left = (cfg.pivX * 100) + '%'; document.getElementById('handlePiv').style.top = (cfg.pivY * 100) + '%';
        }
        window.updateZoom = function(val) { viewportZoom = parseFloat(val); }
        window.toggleAnimation = function() { isAnimating = !isAnimating; const btn = document.getElementById('btnAnim'); if(isAnimating) { btn.innerText = "‚èπ STOP"; btn.classList.add('playing'); } else { btn.innerText = "‚ñ∂ PLAY"; btn.classList.remove('playing'); animTime = 0; } }

        const canvas = document.getElementById('editorCanvas'); const ctx = canvas.getContext('2d');
        function loop() {
            ctx.clearRect(0, 0, 500, 600); ctx.save(); ctx.translate(250, 300); ctx.scale(viewportZoom, viewportZoom); ctx.translate(-250, -300);
            ctx.strokeStyle = '#333'; ctx.lineWidth = 1/viewportZoom; ctx.beginPath(); ctx.moveTo(250,0); ctx.lineTo(250,600); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0,300); ctx.lineTo(500,300); ctx.stroke();

            if (isAnimating) animTime += 0.1; else animTime = 0;
            const walk = Math.sin(animTime); const bob = Math.abs(Math.sin(animTime)) * 10; const breathe = Math.sin(animTime * 0.5) * 0.05;

            LAYER_ORDER.forEach(key => {
                if (hiddenParts[key]) return;
                const img = images[key]; const cfg = avatarConfig.parts[key];
                if (!img || img.isMissing) { if(['tronco','cabeca'].includes(key)) { ctx.save(); ctx.translate(250 + cfg.x, 300 + cfg.y); ctx.fillStyle = 'rgba(255,255,255,0.1)'; ctx.fillRect(-20, -20, 40, 40); ctx.restore(); } return; }

                let animX = 0, animY = 0, animRot = 0;
                let parentX = 0, parentY = 0;

                // L√ìGICA DE PARENTING (ANEXAR)
                if (isAnimating) {
                    // Armas e Escudos seguem os bra√ßos
                    if (key === 'arma_frente' || key === 'escudo_frente') {
                        const parent = avatarConfig.parts['braco_frente'];
                        const pRot = -walk * 0.6; // Rota√ß√£o do bra√ßo frente
                        // Posi√ß√£o do ombro
                        const shoulderX = 250 + parent.x;
                        const shoulderY = 300 + parent.y - bob;
                        // Dist√¢ncia da arma at√© o ombro (baseado na config do editor)
                        const relX = cfg.x - parent.x;
                        const relY = cfg.y - parent.y;
                        // Rotaciona o vetor
                        const rotX = relX * Math.cos(pRot) - relY * Math.sin(pRot);
                        const rotY = relX * Math.sin(pRot) + relY * Math.cos(pRot);
                        
                        // Sobrescreve a l√≥gica padr√£o
                        ctx.save();
                        ctx.translate(shoulderX + rotX, shoulderY + rotY);
                        ctx.rotate(pRot); // Acompanha rota√ß√£o do bra√ßo
                        ctx.drawImage(img, -img.width * cfg.pivX, -img.height * cfg.pivY);
                        if (key === activePart) desenhaGizmo(img, cfg);
                        ctx.restore();
                        return; // Pula o resto
                    }
                    else if (key === 'escudo_tras') {
                        const parent = avatarConfig.parts['braco_tras'];
                        const pRot = walk * 0.6;
                        const shoulderX = 250 + parent.x;
                        const shoulderY = 300 + parent.y - bob;
                        const relX = cfg.x - parent.x;
                        const relY = cfg.y - parent.y;
                        const rotX = relX * Math.cos(pRot) - relY * Math.sin(pRot);
                        const rotY = relX * Math.sin(pRot) + relY * Math.cos(pRot);
                        
                        ctx.save();
                        ctx.translate(shoulderX + rotX, shoulderY + rotY);
                        ctx.rotate(pRot);
                        ctx.filter = "brightness(0.7)";
                        ctx.drawImage(img, -img.width * cfg.pivX, -img.height * cfg.pivY);
                        ctx.filter = "none";
                        if (key === activePart) desenhaGizmo(img, cfg);
                        ctx.restore();
                        return;
                    }

                    // Anima√ß√£o Padr√£o das outras pe√ßas
                    if (key.includes('perna')) {
                        const isFrente = key.includes('frente');
                        animY = -bob; animRot = (isFrente ? walk : -walk) * 0.5;
                    } else if (key.includes('braco')) {
                        const isFrente = key.includes('frente');
                        animY = -bob; animRot = (isFrente ? -walk : walk) * 0.6;
                    } else if (['cabeca', 'rosto', 'mascara', 'cabelo'].includes(key)) {
                        animY = -bob + (breathe * 5); animRot = breathe * 0.2;
                    } else { animY = -bob; }
                }

                ctx.save();
                ctx.translate(250 + cfg.x + animX, 300 + cfg.y + animY);
                ctx.rotate(animRot);
                if (key.includes('tras') || key === 'capa') ctx.filter = "brightness(0.7)";
                ctx.drawImage(img, -img.width * cfg.pivX, -img.height * cfg.pivY);
                ctx.filter = "none";
                if (key === activePart) desenhaGizmo(img, cfg);
                ctx.restore();
            });
            ctx.restore(); requestAnimationFrame(loop);
        }

        function desenhaGizmo(img, cfg) {
            ctx.fillStyle = '#FF5722'; ctx.beginPath(); ctx.arc(0,0, 5/viewportZoom, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#FFC107'; ctx.lineWidth = 2/viewportZoom;
            ctx.strokeRect(-img.width * cfg.pivX, -img.height * cfg.pivY, img.width, img.height);
        }

        window.salvarNoFirebase = async function() {
            if(!MEU_UID_ATUAL) return alert("Voc√™ n√£o est√° logado!");
            if(!confirm("Publicar?")) return;
            try { await setDoc(doc(db, "config", "avatar_base"), { ...avatarConfig, layerOrder: LAYER_ORDER, updatedBy: MEU_UID_ATUAL, updatedAt: new Date().toISOString() }); alert("‚úÖ PUBLICADO!"); } catch(e) { alert("Erro: " + e.message); }
        }
        document.getElementById('btnLogin').addEventListener('click', () => { signInWithPopup(auth, provider).catch(alert); });
        onAuthStateChanged(auth, (user) => { if(user) { MEU_UID_ATUAL = user.uid; document.getElementById('debug-uid').innerText = user.uid.substring(0, 8) + "..."; document.getElementById('login-overlay').style.display = 'none'; init(); } });
    </script>
</body>
</html>
