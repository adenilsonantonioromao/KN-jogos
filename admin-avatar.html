<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Editor de Avatar (Final)</title>
    <style>
        body { 
            background: #1e1e1e; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; 
            margin: 0; height: 100vh; display: flex; flex-direction: column; 
        }

        header {
            background: #2d2d2d; padding: 10px 20px; border-bottom: 1px solid #444;
            display: flex; justify-content: space-between; align-items: center;
        }
        h2 { margin: 0; color: #FF5722; font-size: 1.1rem; }
        
        .btn-save {
            background: #4CAF50; color: white; border: none; padding: 8px 20px;
            border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        .btn-save:hover { background: #43A047; }

        .workspace { display: flex; flex: 1; overflow: hidden; }

        /* COLUNA 1: LISTA */
        .sidebar {
            width: 200px; background: #252526; border-right: 1px solid #444;
            overflow-y: auto; padding: 10px;
        }
        .part-btn {
            display: block; width: 100%; padding: 8px; margin-bottom: 4px;
            background: #333; border: 1px solid #444; color: #aaa;
            text-align: left; cursor: pointer; border-radius: 4px; font-size: 0.85rem;
        }
        .part-btn.active { background: #007ACC; color: white; font-weight: bold; }

        /* COLUNA 2: PREVIEW GLOBAL */
        .viewport {
            flex: 1; background: #111; position: relative;
            display: flex; justify-content: center; align-items: center;
            border-right: 1px solid #444;
        }
        #editorCanvas {
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            background-color: #1a1a1a;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* COLUNA 3: EDITOR DE PIV√î E PROPRIEDADES */
        .inspector {
            width: 350px; background: #252526; 
            display: flex; flex-direction: column;
        }
        
        .pivot-area {
            height: 300px; background: #222; border-bottom: 1px solid #444;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative;
        }
        #pivotCanvas {
            background: url('https://i.imgur.com/3M7qL9p.png'); /* Xadrez */
            border: 1px solid #555; cursor: crosshair;
        }
        
        .properties { padding: 15px; overflow-y: auto; flex: 1; }
        
        .control-group { margin-bottom: 15px; background: #333; padding: 10px; border-radius: 6px; }
        .label-row { display: flex; justify-content: space-between; font-size: 0.8rem; color: #ccc; margin-bottom: 5px; }
        .slider-row { display: flex; align-items: center; gap: 5px; }
        input[type=range] { flex: 1; }
        input[type=number] { width: 50px; background: #222; border: 1px solid #555; color: white; padding: 2px; }

        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 999;
            display: flex; justify-content: center; align-items: center;
        }
        
        #debug-uid {
            background: #000; color: #FFEB3B; padding: 5px 10px; 
            font-family: monospace; font-size: 0.8rem; border: 1px solid #555;
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div style="text-align:center;">
            <h1 style="color:white;">üîê Admin Avatar</h1>
            <button id="btnLogin" class="btn-save" style="background:#2196F3; padding:15px 30px;">Entrar com Google</button>
        </div>
    </div>

    <header>
        <h2>Editor de Avatar</h2>
        <div id="debug-uid">Verificando...</div>
        
        <div style="display:flex; gap:10px; align-items:center;">
            <span style="font-size:0.8rem; color:#aaa;">Zoom:</span>
            <input type="range" min="0.5" max="3" step="0.1" value="1" oninput="updateZoom(this.value)">
            <button id="btnPublish" class="btn-save" onclick="salvarNoFirebase()">üíæ PUBLICAR</button>
        </div>
    </header>

    <div class="workspace">
        <div class="sidebar" id="partsList"></div>
        <div class="viewport">
            <canvas id="editorCanvas" width="500" height="600"></canvas>
        </div>
        <div class="inspector">
            <div class="pivot-area">
                <div style="position:absolute; top:5px; left:10px; font-size:0.8rem; color:#aaa;">üìç Editor de Piv√¥</div>
                <canvas id="pivotCanvas" width="250" height="250"></canvas>
            </div>
            <div class="properties">
                <h3 id="selectedPartName" style="margin-top:0; color:#2196F3;">Tronco</h3>
                <div class="control-group">
                    <div class="label-row"><span>Posi√ß√£o X</span></div>
                    <div class="slider-row">
                        <input type="range" id="inpX" min="-200" max="200" oninput="updateConfig('x', this.value)">
                        <input type="number" id="numX" onchange="updateConfig('x', this.value)">
                    </div>
                    <div class="label-row" style="margin-top:5px;"><span>Posi√ß√£o Y</span></div>
                    <div class="slider-row">
                        <input type="range" id="inpY" min="-300" max="300" oninput="updateConfig('y', this.value)">
                        <input type="number" id="numY" onchange="updateConfig('y', this.value)">
                    </div>
                </div>
                <div class="control-group">
                    <div class="label-row"><span>Piv√¥ X (Fino)</span></div>
                    <div class="slider-row">
                        <input type="range" id="inpPivX" min="0" max="1" step="0.01" oninput="updateConfig('pivX', this.value)">
                        <input type="number" id="numPivX" step="0.01" onchange="updateConfig('pivX', this.value)">
                    </div>
                    <div class="label-row" style="margin-top:5px;"><span>Piv√¥ Y (Fino)</span></div>
                    <div class="slider-row">
                        <input type="range" id="inpPivY" min="0" max="1" step="0.01" oninput="updateConfig('pivY', this.value)">
                        <input type="number" id="numPivY" step="0.01" onchange="updateConfig('pivY', this.value)">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // --- AQUI ESTAVA O ERRO: FALTAVA IMPORTAR O APP CHECK ---
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIR7CqYYvMZVQxtO67JCQoJ3OLT1cvAx8",
            authDomain: "kn-jogos.firebaseapp.com",
            projectId: "kn-jogos",
            storageBucket: "kn-jogos.firebasestorage.app",
            messagingSenderId: "273132829744",
            appId: "1:273132829744:web:a03e85b80ffabfa24101f5"
        };

        const app = initializeApp(firebaseConfig);
        
        // --- INICIALIZA O APP CHECK PARA O GITHUB/FIREBASE ACEITAR ---
        try {
            const appCheck = initializeAppCheck(app, { 
                provider: new ReCaptchaV3Provider('6Lc5vjgsAAAAANx2ia8s_Fh0_KS0_YNaAlSIYpJC'), 
                isTokenAutoRefreshEnabled: true 
            });
        } catch(e) { console.warn("App Check Warn:", e); }

        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- VARI√ÅVEIS ---
        let viewportZoom = 1.0;
        let activePart = 'tronco';
        const images = {};
        const BASE_URL = 'assets/avatar/base/';
        let MEU_UID_ATUAL = ""; 

        // ORDEM DE CAMADAS (14 Itens)
        const LAYER_ORDER = [
            'capa', 'escudo_tras', 'braco_tras', 'perna_tras', 'perna_frente',
            'tronco', 'cintura', 'cabeca', 'rosto', 'mascara', 'cabelo',
            'arma_frente', 'braco_frente', 'escudo_frente'
        ];

        let avatarConfig = { scale: 0.22, parts: {} };
        LAYER_ORDER.forEach(k => { avatarConfig.parts[k] = { x: 0, y: 0, pivX: 0.5, pivY: 0.5 }; });

        // --- FUN√á√ïES ---
        function init() {
            createSidebar();
            loadImages();
            loadConfigFromDb();
            loop();
            drawPivotEditor();
        }

        async function loadConfigFromDb() {
            console.log("Carregando dados...");
            try {
                const snap = await getDoc(doc(db, "config", "avatar_base"));
                if (snap.exists()) {
                    const data = snap.data();
                    avatarConfig.scale = data.scale || 0.22;
                    LAYER_ORDER.forEach(k => { if(data.parts[k]) avatarConfig.parts[k] = data.parts[k]; });
                    selectPart('tronco');
                    
                    const btn = document.getElementById('btnPublish');
                    btn.innerText = "DADOS CARREGADOS!";
                    btn.style.background = "#2196F3";
                    setTimeout(() => { btn.innerText = "üíæ PUBLICAR"; btn.style.background = "#4CAF50"; }, 2000);
                }
            } catch(e) { console.log("Erro load:", e); }
        }

        function createSidebar() {
            const list = document.getElementById('partsList');
            list.innerHTML = '';
            LAYER_ORDER.forEach((key, index) => {
                const btn = document.createElement('div');
                btn.className = 'part-btn';
                btn.id = `btn-${key}`;
                btn.innerText = `${index}. ${key.toUpperCase().replace('_', ' ')}`;
                btn.onclick = () => selectPart(key);
                list.appendChild(btn);
            });
        }

        function loadImages() {
            LAYER_ORDER.forEach(name => {
                const img = new Image();
                img.src = `${BASE_URL}${name}.png`;
                img.onload = () => { if(name === activePart) drawPivotEditor(); };
                img.onerror = () => img.isMissing = true;
                images[name] = img;
            });
        }

        function selectPart(key) {
            activePart = key;
            document.querySelectorAll('.part-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${key}`).classList.add('active');
            document.getElementById('selectedPartName').innerText = key.toUpperCase().replace('_', ' ');
            const data = avatarConfig.parts[key];
            setInput('X', data.x); setInput('Y', data.y); setInput('PivX', data.pivX); setInput('PivY', data.pivY);
            drawPivotEditor();
        }

        function setInput(suffix, val) {
            document.getElementById('inp' + suffix).value = val;
            document.getElementById('num' + suffix).value = val;
        }

        window.updateConfig = function(field, val) {
            const num = parseFloat(val);
            avatarConfig.parts[activePart][field] = num;
            const suffix = field.charAt(0).toUpperCase() + field.slice(1);
            const idBase = field.startsWith('piv') ? 'Piv' + field.charAt(3) : suffix;
            if(document.activeElement.type === 'range') document.getElementById('num' + idBase).value = num;
            else document.getElementById('inp' + idBase).value = num;
            if(field.startsWith('piv')) drawPivotEditor();
        }

        window.updateZoom = function(val) { viewportZoom = parseFloat(val); }

        const pCanvas = document.getElementById('pivotCanvas');
        const pCtx = pCanvas.getContext('2d');

        function drawPivotEditor() {
            pCtx.clearRect(0, 0, 250, 250);
            pCtx.strokeStyle = '#444'; pCtx.beginPath();
            pCtx.moveTo(125,0); pCtx.lineTo(125,250); pCtx.moveTo(0,125); pCtx.lineTo(250,125); pCtx.stroke();

            const img = images[activePart];
            const cfg = avatarConfig.parts[activePart];

            if (!img || img.isMissing) {
                pCtx.fillStyle = '#333'; pCtx.fillText("Sem Imagem", 90, 125);
                return;
            }
            const scale = Math.min(200/img.width, 200/img.height, 1); 
            const dw = img.width * scale; const dh = img.height * scale;
            const dx = (250 - dw) / 2; const dy = (250 - dh) / 2;
            pCtx.drawImage(img, dx, dy, dw, dh);
            const px = dx + (cfg.pivX * dw); const py = dy + (cfg.pivY * dh);
            pCtx.fillStyle = '#FF0000'; pCtx.beginPath(); pCtx.arc(px, py, 5, 0, Math.PI*2); pCtx.fill();
            pCtx.strokeStyle = 'white'; pCtx.lineWidth = 2; pCtx.stroke();
        }

        let draggingPivot = false;
        pCanvas.addEventListener('mousedown', () => draggingPivot = true);
        window.addEventListener('mouseup', () => draggingPivot = false);
        pCanvas.addEventListener('mousemove', (e) => {
            if(!draggingPivot) return;
            const rect = pCanvas.getBoundingClientRect();
            const img = images[activePart];
            if(!img || img.isMissing) return;
            const scale = Math.min(200/img.width, 200/img.height, 1);
            const dw = img.width * scale; const dh = img.height * scale;
            const dx = (250 - dw) / 2; const dy = (250 - dh) / 2;
            const mouseX = e.clientX - rect.left; const mouseY = e.clientY - rect.top;
            let relX = (mouseX - dx) / dw; let relY = (mouseY - dy) / dh;
            updateConfig('pivX', relX.toFixed(3)); updateConfig('pivY', relY.toFixed(3));
        });

        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d');

        function loop() {
            ctx.clearRect(0, 0, 500, 600);
            ctx.save();
            ctx.translate(250, 300); ctx.scale(viewportZoom, viewportZoom); ctx.translate(-250, -300);
            ctx.strokeStyle = '#333'; ctx.lineWidth = 1/viewportZoom;
            ctx.beginPath(); ctx.moveTo(250,0); ctx.lineTo(250,600); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0,300); ctx.lineTo(500,300); ctx.stroke();

            LAYER_ORDER.forEach(key => {
                const img = images[key];
                const cfg = avatarConfig.parts[key];
                if (!img || img.isMissing) {
                    if(['tronco','cabeca'].includes(key)) {
                        ctx.save(); ctx.translate(250 + cfg.x, 300 + cfg.y);
                        ctx.fillStyle = 'rgba(255,255,255,0.1)'; ctx.fillRect(-20, -20, 40, 40); ctx.restore();
                    }
                    return;
                }
                ctx.save(); ctx.translate(250 + cfg.x, 300 + cfg.y);
                ctx.drawImage(img, -img.width * cfg.pivX, -img.height * cfg.pivY);
                if (key === activePart) {
                    ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(0,0, 4/viewportZoom, 0, Math.PI*2); ctx.fill();
                    ctx.strokeStyle = 'yellow'; ctx.lineWidth = 2/viewportZoom;
                    ctx.strokeRect(-img.width * cfg.pivX, -img.height * cfg.pivY, img.width, img.height);
                }
                ctx.restore();
            });
            ctx.restore();
            requestAnimationFrame(loop);
        }

        window.salvarNoFirebase = async function() {
            if(!MEU_UID_ATUAL) return alert("Voc√™ n√£o est√° logado!");
            try {
                await setDoc(doc(db, "config", "avatar_base"), {
                    ...avatarConfig,
                    layerOrder: LAYER_ORDER,
                    updatedBy: MEU_UID_ATUAL,
                    updatedAt: new Date().toISOString()
                });
                alert("‚úÖ PUBLICADO COM SUCESSO!");
            } catch(e) {
                console.error(e);
                alert(`‚ùå ERRO: ${e.message}`);
            }
        }

        document.getElementById('btnLogin').addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(alert);
        });

        onAuthStateChanged(auth, (user) => {
            if(user) {
                MEU_UID_ATUAL = user.uid; 
                document.getElementById('debug-uid').innerText = "UID: " + user.uid;
                document.getElementById('login-overlay').style.display = 'none';
                init();
            }
        });

    </script>
</body>
</html>
