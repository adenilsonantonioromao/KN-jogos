<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Editor de Avatar</title>
    <style>
        body { 
            background: #1e1e1e; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; 
            margin: 0; height: 100vh; display: flex; flex-direction: column; 
        }

        /* BARRA SUPERIOR */
        header {
            background: #2d2d2d; padding: 15px 20px; border-bottom: 1px solid #444;
            display: flex; justify-content: space-between; align-items: center;
        }
        h2 { margin: 0; color: #FF5722; font-size: 1.2rem; }
        
        .btn-save {
            background: #4CAF50; color: white; border: none; padding: 10px 25px;
            border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1rem;
            transition: 0.2s;
        }
        .btn-save:hover { background: #43A047; }

        /* LAYOUT PRINCIPAL */
        .workspace { display: flex; flex: 1; overflow: hidden; }

        /* COLUNA 1: LISTA DE PE√áAS */
        .sidebar {
            width: 220px; background: #252526; border-right: 1px solid #444;
            overflow-y: auto; padding: 10px;
        }
        .part-btn {
            display: block; width: 100%; padding: 10px; margin-bottom: 5px;
            background: #333; border: 1px solid #444; color: #aaa;
            text-align: left; cursor: pointer; border-radius: 4px; font-size: 0.9rem;
        }
        .part-btn:hover { background: #3e3e42; }
        .part-btn.active { 
            background: #007ACC; color: white; border-color: #007ACC; 
            font-weight: bold;
        }

        /* COLUNA 2: CANVAS (VISUALIZA√á√ÉO) */
        .viewport {
            flex: 1; background: #111; position: relative;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }
        canvas {
            background-image: linear-gradient(45deg, #222 25%, transparent 25%), 
                              linear-gradient(-45deg, #222 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #222 75%), 
                              linear-gradient(-45deg, transparent 75%, #222 75%);
            background-size: 20px 20px;
            background-color: #1a1a1a;
            border: 2px solid #444;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        /* COLUNA 3: CONTROLES */
        .inspector {
            width: 320px; background: #252526; border-left: 1px solid #444;
            padding: 20px; overflow-y: auto;
        }
        .control-group { margin-bottom: 20px; background: #333; padding: 15px; border-radius: 8px; }
        .control-label { display: block; margin-bottom: 5px; font-size: 0.8rem; color: #ccc; }
        .slider-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        input[type=range] { flex: 1; cursor: pointer; }
        input[type=number] { width: 60px; background: #222; border: 1px solid #555; color: white; padding: 5px; border-radius: 4px; }

        /* MODO LOGIN */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999;
            display: flex; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div style="text-align:center; color:white;">
            <h1>üîí √Årea Restrita</h1>
            <button id="btnLogin" class="btn-save" style="background:#2196F3;">Entrar como Admin</button>
        </div>
    </div>

    <header>
        <h2>üõ†Ô∏è Editor de Avatar Base</h2>
        <button class="btn-save" onclick="salvarNoFirebase()">üíæ SALVAR NO BANCO</button>
    </header>

    <div class="workspace">
        <!-- SELETOR DE PE√áAS -->
        <div class="sidebar" id="partsList">
            <!-- Bot√µes gerados via JS -->
        </div>

        <!-- CANVAS -->
        <div class="viewport">
            <canvas id="editorCanvas" width="600" height="600"></canvas>
        </div>

        <!-- PROPRIEDADES -->
        <div class="inspector">
            
            <!-- NOVO: CONTROLE DE ZOOM -->
            <div class="control-group" style="background: #2D2D30; border: 1px solid #444;">
                <label class="control-label" style="color: #4CAF50; font-weight: bold;">üîç ZOOM DA C√ÇMERA</label>
                <div class="slider-row">
                    <input type="range" id="globalZoom" min="0.5" max="3" step="0.1" value="1" oninput="updateZoom(this.value)">
                    <span id="zoomDisplay" style="width: 30px; text-align: right; font-size: 0.8rem;">1.0x</span>
                </div>
            </div>

            <h3 id="selectedPartName" style="margin-top:0; color:#2196F3;">Selecione uma pe√ßa</h3>
            
            <div class="control-group">
                <label class="control-label">üìç Posi√ß√£o X (Offset)</label>
                <div class="slider-row">
                    <input type="range" id="inpX" min="-300" max="300" step="1" oninput="updateConfig('x', this.value)">
                    <input type="number" id="numX" onchange="updateConfig('x', this.value)">
                </div>

                <label class="control-label">üìç Posi√ß√£o Y (Offset)</label>
                <div class="slider-row">
                    <input type="range" id="inpY" min="-300" max="300" step="1" oninput="updateConfig('y', this.value)">
                    <input type="number" id="numY" onchange="updateConfig('y', this.value)">
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">üéØ Piv√¥ X (0.0 a 1.0)</label>
                <div class="slider-row">
                    <input type="range" id="inpPivX" min="0" max="1" step="0.01" oninput="updateConfig('pivX', this.value)">
                    <input type="number" id="numPivX" step="0.01" onchange="updateConfig('pivX', this.value)">
                </div>

                <label class="control-label">üéØ Piv√¥ Y (0.0 a 1.0)</label>
                <div class="slider-row">
                    <input type="range" id="inpPivY" min="0" max="1" step="0.01" oninput="updateConfig('pivY', this.value)">
                    <input type="number" id="numPivY" step="0.01" onchange="updateConfig('pivY', this.value)">
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Z-Index (Ordem de Camada)</label>
                <input type="number" id="layerIndex" disabled style="width:100%; opacity:0.5;">
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBIR7CqYYvMZVQxtO67JCQoJ3OLT1cvAx8",
            authDomain: "kn-jogos.firebaseapp.com",
            projectId: "kn-jogos",
            storageBucket: "kn-jogos.firebasestorage.app",
            messagingSenderId: "273132829744",
            appId: "1:273132829744:web:a03e85b80ffabfa24101f5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const ADMIN_ID = "0wCjH6RgGmgpYfRcRQunjmymy4O2";

        // --- VARI√ÅVEIS DO EDITOR ---
        let viewportZoom = 1.0;

        // --- DADOS DO AVATAR ---
        let avatarConfig = {
            scale: 0.22, 
            parts: {
                // Configura√ß√£o inicial (placeholder) - voc√™ vai ajustar visualmente
                'capa': { x: 0, y: 0, pivX: 0.5, pivY: 0.5 },
                'perna_tras': { x: -24, y: 50, pivX: 0.67, pivY: 0.11 },
                'perna_frente': { x: 24, y: 50, pivX: 0.29, pivY: 0.13 },
                'escudo_tras': { x: 0, y: 0, pivX: 0.5, pivY: 0.5 },
                'braco_tras': { x: -37, y: -150, pivX: 0.76, pivY: 0.11 },
                'tronco': { x: 0, y: 0, pivX: 0.47, pivY: 0.75 },
                'cintura': { x: 0, y: 0, pivX: 0.5, pivY: 0.5 },
                'cabeca': { x: 0, y: -230, pivX: 0.50, pivY: 0.89 },
                'rosto': { x: 0, y: -230, pivX: 0.5, pivY: 0.5 },
                'mascara': { x: 0, y: -230, pivX: 0.5, pivY: 0.5 },
                'cabelo': { x: 0, y: -230, pivX: 0.5, pivY: 0.5 },
                'arma_frente': { x: 0, y: 0, pivX: 0.5, pivY: 0.5 },
                'braco_frente': { x: 47, y: -150, pivX: 0.26, pivY: 0.12 },
                'escudo_frente': { x: 0, y: 0, pivX: 0.5, pivY: 0.5 }
            }
        };

        // NOVA ORDEM DE RENDERIZA√á√ÉO SOLICITADA
        const LAYER_ORDER = [
            'capa',             // 0
            'braco_tras',       // 1
            'perna_tras',       // 2
            'perna_frente',     // 3
            'escudo_tras',      // 4
            'tronco',           // 5
            'cintura',          // 6 (novo)
            'cabeca',           // 7
            'rosto',            // 8
            'mascara',          // 9
            'cabelo',           // 10
            'arma_frente',      // 11
            'braco_frente',     // 12
            'escudo_frente'     // 13
        ];

        const images = {};
        const BASE_URL = 'assets/avatar/base/';
        let activePart = 'tronco';

        // --- SISTEMA ---

        function init() {
            createSidebar();
            loadImages();
            loop();
        }

        function createSidebar() {
            const list = document.getElementById('partsList');
            LAYER_ORDER.forEach((key, index) => {
                const btn = document.createElement('div');
                btn.className = 'part-btn';
                btn.innerText = `${index}. ${key.toUpperCase().replace('_', ' ')}`;
                btn.onclick = () => selectPart(key, btn);
                if (key === 'tronco') btn.classList.add('active'); 
                list.appendChild(btn);
            });
        }

        function loadImages() {
            LAYER_ORDER.forEach(name => {
                const img = new Image();
                img.src = `${BASE_URL}${name}.png`;
                img.onload = () => console.log(`Carregado: ${name}`);
                img.onerror = () => img.isMissing = true;
                images[name] = img;
            });
        }

        function selectPart(key, btnElement) {
            activePart = key;
            document.querySelectorAll('.part-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
            
            document.getElementById('selectedPartName').innerText = key.toUpperCase().replace('_', ' ');
            const data = avatarConfig.parts[key];
            
            setInput('X', data.x);
            setInput('Y', data.y);
            setInput('PivX', data.pivX);
            setInput('PivY', data.pivY);
            document.getElementById('layerIndex').value = LAYER_ORDER.indexOf(key);
        }

        function setInput(suffix, val) {
            document.getElementById('inp' + suffix).value = val;
            document.getElementById('num' + suffix).value = val;
        }

        window.updateConfig = function(field, val) {
            const num = parseFloat(val);
            avatarConfig.parts[activePart][field] = num;
            
            const suffix = field.charAt(0).toUpperCase() + field.slice(1);
            const numId = 'num' + (field.startsWith('piv') ? 'Piv' + field.charAt(3) : suffix);
            const rngId = 'inp' + (field.startsWith('piv') ? 'Piv' + field.charAt(3) : suffix);
            
            if(document.activeElement.type === 'range') document.getElementById(numId).value = num;
            else document.getElementById(rngId).value = num;
        }

        // NOVO: Atualiza o Zoom
        window.updateZoom = function(val) {
            viewportZoom = parseFloat(val);
            document.getElementById('zoomDisplay').innerText = viewportZoom.toFixed(1) + 'x';
        }

        // --- RENDERIZA√á√ÉO ---
        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d');

        function drawPart(key) {
            const img = images[key];
            const cfg = avatarConfig.parts[key];

            // Desenha placeholder se faltar a imagem
            if (!img || img.isMissing) {
                // Mostra um quadrado semitransparente apenas para pe√ßas essenciais para orientar
                if(['tronco','cabeca','braco','perna'].some(k => key.includes(k))) {
                    ctx.save();
                    ctx.translate(300 + cfg.x, 300 + cfg.y);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                    ctx.strokeStyle = '#666';
                    ctx.setLineDash([5, 5]);
                    ctx.strokeRect(-25, -25, 50, 50);
                    ctx.restore();
                }
                return;
            }

            ctx.save();
            // Centraliza na tela (300, 300) + Offset
            ctx.translate(300 + cfg.x, 300 + cfg.y);
            
            const w = img.width;
            const h = img.height;

            // Desenha com Piv√¥
            ctx.drawImage(img, -w * cfg.pivX, -h * cfg.pivY);

            // Gizmo (Se selecionado)
            if (key === activePart) {
                ctx.fillStyle = '#FF5722';
                ctx.beginPath(); ctx.arc(0,0, 6/viewportZoom, 0, Math.PI*2); ctx.fill(); // Ponto ajusta com zoom
                ctx.strokeStyle = '#FFC107';
                ctx.lineWidth = 2 / viewportZoom;
                ctx.strokeRect(-w * cfg.pivX, -h * cfg.pivY, w, h);
            }

            ctx.restore();
        }

        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.save();
            
            // --- APLICA O ZOOM GLOBAL ---
            // 1. Move para o centro
            ctx.translate(300, 300);
            // 2. Aplica escala
            ctx.scale(viewportZoom, viewportZoom);
            // 3. Move de volta (para que o zoom seja no centro, n√£o no canto 0,0)
            ctx.translate(-300, -300);

            // Linhas Guia
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1 / viewportZoom; // Mant√©m a linha fina mesmo com zoom
            ctx.beginPath(); ctx.moveTo(300,0); ctx.lineTo(300,600); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0,300); ctx.lineTo(600,300); ctx.stroke();

            // Desenha na ordem
            LAYER_ORDER.forEach(key => {
                if (key.includes('tras') || key === 'capa') ctx.filter = "brightness(0.7)";
                drawPart(key);
                ctx.filter = "none";
            });
            
            ctx.restore(); // Remove o zoom para o pr√≥ximo frame

            requestAnimationFrame(loop);
        }

        // --- SALVAR ---
        window.salvarNoFirebase = async function() {
            if(!confirm("Salvar configura√ß√£o PADR√ÉO? Isso afetar√° todos os jogadores.")) return;
            try {
                // Adiciona o Layer Order no objeto salvo para garantir integridade
                const dadosParaSalvar = {
                    ...avatarConfig,
                    layerOrder: LAYER_ORDER
                };
                
                await setDoc(doc(db, "config", "avatar_base"), dadosParaSalvar);
                alert("‚úÖ Configura√ß√£o Salva! V√° para a Parte 3 para integrar.");
            } catch(e) {
                alert("Erro ao salvar: " + e.message);
            }
        }

        document.getElementById('btnLogin').addEventListener('click', () => {
            signInWithPopup(auth, provider).then((result) => {
                if(result.user.uid === ADMIN_ID) {
                    document.getElementById('login-overlay').style.display = 'none';
                    init();
                } else {
                    alert("Acesso Negado.");
                }
            });
        });

        onAuthStateChanged(auth, (user) => {
            if(user && user.uid === ADMIN_ID) {
                document.getElementById('login-overlay').style.display = 'none';
                init();
            }
        });

    </script>
</body>
</html>
