<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - Avatar Studio (Layout Real)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&display=swap');
        
        :root { 
            --primary: #FF5722; --bg: #222; --dark: #eee; --green: #4CAF50;
            --shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        * { box-sizing: border-box; }
        
        body { 
            margin: 0; height: 100vh; background-color: var(--bg); 
            font-family: 'Nunito', sans-serif; overflow: hidden; 
            display: flex; flex-direction: column; color: var(--dark); 
            user-select: none;
        }

        /* HEADER */
        header {
            background: #2d2d2d; padding: 10px 20px; border-bottom: 1px solid #444;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        h2 { margin: 0; color: #FF5722; font-family: 'Fredoka One'; font-size: 1.2rem; }
        
        .btn {
            border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; gap: 5px; transition: 0.2s; font-size: 0.9rem;
        }
        .btn-save { background: #4CAF50; color: white; }
        .btn-load { background: #FF9800; color: white; }
        .btn-anim { background: #673AB7; color: white; width: 100px; justify-content: center; }
        .btn-anim.playing { background: #F44336; }

        /* LAYOUT PRINCIPAL (Igual Comunidade) */
        .main-layout { display: flex; flex: 1; height: 100%; padding: 15px; gap: 15px; overflow: hidden; }

        /* ESQUERDA: VISUALIZA√á√ÉO (Igual Jogo) */
        .game-column { 
            flex: 2; display: flex; flex-direction: column; gap: 15px; position: relative; min-width: 0; 
        }
        
        .canvas-card { 
            flex: 1; background: #81D4FA; border-radius: 30px; overflow: hidden; 
            box-shadow: var(--shadow); position: relative; border: 5px solid #444; 
            display: flex; min-height: 200px;
        }
        
        canvas { 
            display: block; width: 100%; height: 100%; 
            background: linear-gradient(to bottom, #81D4FA, #B2EBF2); 
        }

        /* DIREITA: FERRAMENTAS */
        .right-column {
            flex: 1; min-width: 320px; background: #2d2d2d; border-radius: 30px;
            box-shadow: var(--shadow); display: flex; flex-direction: column;
            overflow: hidden; border: 5px solid #444; position: relative;
        }

        .tools-header {
            background: var(--primary); color: white; padding: 15px;
            font-family: 'Fredoka One'; text-align: center;
        }

        .tools-content {
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px;
        }

        /* BOTOES DE PE√áAS */
        .parts-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px;
        }
        .part-btn {
            background: #444; border: 1px solid #555; color: #ccc; padding: 8px;
            cursor: pointer; text-align: left; font-size: 0.8rem; border-radius: 5px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .part-btn:hover { background: #555; }
        .part-btn.active { background: #2196F3; color: white; border-color: #64B5F6; }

        .eye-icon { cursor: pointer; padding: 0 5px; font-size: 1rem; }
        .eye-icon:hover { color: #fff; }

        /* JOYSTICKS (PADS) */
        .control-box { background: #333; padding: 10px; border-radius: 10px; border: 1px solid #444; }
        .control-title { font-size: 0.75rem; color: #aaa; margin-bottom: 5px; text-transform: uppercase; font-weight: bold; }
        
        .xy-pad-container {
            position: relative; width: 100%; padding-top: 100%; 
            background: #222; border: 1px solid #555; border-radius: 4px;
            cursor: crosshair; overflow: hidden;
        }
        .xy-grid {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(#333 1px, transparent 1px), linear-gradient(90deg, #333 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .xy-axis { position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: #444; } 
        .xy-axis.vert { top: 0; left: 50%; width: 1px; height: 100%; }
        .xy-handle { 
            position: absolute; width: 12px; height: 12px; background: #2196F3; 
            border: 2px solid white; border-radius: 50%; 
            transform: translate(-50%, -50%); top: 50%; left: 50%; pointer-events: none; 
        }

        #fileInput { display: none; }

        /* MOBILE */
        @media (max-width: 850px) {
            .main-layout { flex-direction: column; padding: 10px; gap: 10px; }
            .game-column { flex: 1; height: 50%; }
            .right-column { flex: 1; min-width: auto; border-radius: 25px; height: 50%; }
        }
    </style>
</head>
<body>

    <header>
        <h2>üõ†Ô∏è Studio</h2>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-anim" id="btnAnim" onclick="toggleAnimation()">‚ñ∂ ANIMAR</button>
            <button class="btn btn-load" onclick="document.getElementById('fileInput').click()">üìÇ CARREGAR</button>
            <input type="file" id="fileInput" accept=".json" onchange="carregarArquivo(this)">
            <button class="btn btn-save" onclick="salvarArquivo()">üíæ SALVAR</button>
        </div>
    </header>

    <div class="main-layout">
        <!-- ESQUERDA: PREVIEW IGUAL AO JOGO -->
        <div class="game-column">
            <div class="canvas-card" id="canvasContainer">
                <canvas id="editorCanvas"></canvas>
            </div>
        </div>

        <!-- DIREITA: FERRAMENTAS -->
        <div class="right-column">
            <div class="tools-header">‚öôÔ∏è Configura√ß√£o</div>
            <div class="tools-content">
                
                <div class="control-box">
                    <div class="control-title">Selecionar Pe√ßa</div>
                    <div class="parts-grid" id="partsList"></div>
                </div>

                <!-- PAD POSI√á√ÉO -->
                <div class="control-box">
                    <div class="control-title" style="display:flex; justify-content:space-between;">
                        <span>üìç Posi√ß√£o (Offset)</span>
                        <span id="valPos" style="color:#2196F3">0, 0</span>
                    </div>
                    <div class="xy-pad-container" id="padPos">
                        <div class="xy-grid"></div><div class="xy-axis"></div><div class="xy-axis vert"></div>
                        <div class="xy-handle" id="handlePos"></div>
                    </div>
                </div>

                <!-- PAD PIV√î -->
                <div class="control-box">
                    <div class="control-title" style="display:flex; justify-content:space-between;">
                        <span>üéØ Piv√¥ (Rota√ß√£o)</span>
                        <span id="valPiv" style="color:#2196F3">0.5, 0.5</span>
                    </div>
                    <div class="xy-pad-container" id="padPiv">
                        <div class="xy-grid" style="background-size:10px 10px; opacity:0.3;"></div>
                        <div class="xy-handle" id="handlePiv" style="background:#FF5722;"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- DADOS ---
        let activePart = 'tronco';
        let isAnimating = false;
        let animTime = 0;
        let hiddenParts = {}; 
        const images = {};
        const BASE_URL = 'assets/avatar/base/';

        // --- ORDEM DE CAMADAS ---
        const LAYER_ORDER = [
            'capa', 'escudo_tras', 'braco_tras', 'perna_tras', 'perna_frente',
            'tronco', 'cintura', 'cabeca', 'rosto', 'mascara', 'cabelo',
            'arma_frente', 'braco_frente', 'escudo_frente'
        ];

        // --- MAPA DE ARQUIVOS ---
        const FILE_NAMES = {
            'capa': 'capa_simples.png',
            'escudo_tras': 'escudo_simples_tras.png',
            'braco_tras': 'braco_tras_padrao.png',
            'perna_tras': 'perna_tras_padrao.png',
            'perna_frente': 'perna_frente_padrao.png',
            'tronco': 'tronco_padrao.png',
            'cintura': 'espada_bainha_simples.png',
            'cabeca': 'cabeca_padrao.png',
            'rosto': 'rosto_padrao.png',
            'mascara': 'mascara_simples.png',
            'cabelo': 'cabelo_simples.png',
            'arma_frente': 'Espada_simples.png',
            'braco_frente': 'braco_frente_padrao.png',
            'escudo_frente': 'escudo_simples.png'
        };

        // --- CONFIG INICIAL ---
        let avatarConfig = { scale: 0.22, parts: {} };
        LAYER_ORDER.forEach(k => { avatarConfig.parts[k] = { x: 0, y: 0, pivX: 0.5, pivY: 0.5 }; });

        // --- INICIALIZA√á√ÉO ---
        function init() {
            createSidebar();
            loadImages();
            setupPads();
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            requestAnimationFrame(loop);
        }

        // --- GERENCIAMENTO DE ARQUIVOS ---
        window.salvarArquivo = function() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(avatarConfig, null, 4));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "avatar_config.json");
            document.body.appendChild(node);
            node.click();
            node.remove();
        }

        window.carregarArquivo = function(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loaded = JSON.parse(e.target.result);
                    if(loaded.parts) {
                        avatarConfig = loaded;
                        alert("‚úÖ Configura√ß√£o carregada!");
                        selectPart('tronco');
                    } else alert("‚ùå Arquivo inv√°lido.");
                } catch(err) { alert("‚ùå Erro ao ler JSON."); }
            };
            reader.readAsText(file);
            input.value = ""; 
        }

        // --- UI E PADS ---
        function createSidebar() {
            const list = document.getElementById('partsList');
            list.innerHTML = '';
            LAYER_ORDER.forEach((key, index) => {
                const btn = document.createElement('div');
                btn.className = 'part-btn';
                btn.id = `btn-${key}`;
                btn.innerHTML = `<span>${key}</span> <span class="eye-icon" onclick="event.stopPropagation(); toggleVis('${key}', this)">üëÅÔ∏è</span>`;
                btn.onclick = () => selectPart(key);
                list.appendChild(btn);
            });
            selectPart('tronco');
        }

        window.toggleVis = function(key, el) {
            if(hiddenParts[key]) {
                delete hiddenParts[key]; el.innerText = "üëÅÔ∏è"; el.style.opacity = 1;
            } else {
                hiddenParts[key] = true; el.innerText = "‚ùå"; el.style.opacity = 0.5;
            }
        }

        function loadImages() {
            LAYER_ORDER.forEach(layerName => {
                const img = new Image();
                const fileName = FILE_NAMES[layerName] || (layerName + ".png");
                img.src = `${BASE_URL}${fileName}`;
                img.onerror = () => { img.isMissing = true; };
                images[layerName] = img;
            });
        }

        function selectPart(key) {
            activePart = key;
            document.querySelectorAll('.part-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${key}`).classList.add('active');
            updatePadsUI();
        }

        function setupPads() {
            setupDraggable('padPos', (rx, ry) => {
                const x = Math.round((rx - 0.5) * 400); 
                const y = Math.round((ry - 0.5) * 600);
                avatarConfig.parts[activePart].x = x;
                avatarConfig.parts[activePart].y = y;
                updatePadsUI(true);
            });
            setupDraggable('padPiv', (rx, ry) => {
                avatarConfig.parts[activePart].pivX = parseFloat(rx.toFixed(3));
                avatarConfig.parts[activePart].pivY = parseFloat(ry.toFixed(3));
                updatePadsUI(true);
            });
        }

        function setupDraggable(id, callback) {
            const el = document.getElementById(id);
            let isDragging = false;
            const update = (e) => {
                const rect = el.getBoundingClientRect();
                let x = (e.clientX - rect.left) / rect.width;
                let y = (e.clientY - rect.top) / rect.height;
                x = Math.max(0, Math.min(1, x)); y = Math.max(0, Math.min(1, y));
                callback(x, y);
            };
            el.addEventListener('mousedown', (e) => { isDragging = true; update(e); });
            window.addEventListener('mousemove', (e) => { if(isDragging) update(e); });
            window.addEventListener('mouseup', () => isDragging = false);
        }

        function updatePadsUI(skipLogic) {
            const cfg = avatarConfig.parts[activePart];
            if(!skipLogic) {
                document.getElementById('valPos').innerText = `${cfg.x}, ${cfg.y}`;
                document.getElementById('valPiv').innerText = `${cfg.pivX}, ${cfg.pivY}`;
            }
            const rx = (cfg.x / 400) + 0.5; const ry = (cfg.y / 600) + 0.5;
            document.getElementById('handlePos').style.left = (rx * 100) + '%';
            document.getElementById('handlePos').style.top = (ry * 100) + '%';
            document.getElementById('handlePiv').style.left = (cfg.pivX * 100) + '%';
            document.getElementById('handlePiv').style.top = (cfg.pivY * 100) + '%';
        }
        
        window.toggleAnimation = function() {
            isAnimating = !isAnimating;
            const btn = document.getElementById('btnAnim');
            if(isAnimating) { btn.innerText = "‚èπ STOP"; btn.classList.add('playing'); } 
            else { btn.innerText = "‚ñ∂ ANIMAR"; btn.classList.remove('playing'); animTime = 0; }
        }

        // --- RENDERIZA√á√ÉO ---
        const canvas = document.getElementById('editorCanvas');
        const container = document.getElementById('canvasContainer');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();
            if(rect.width === 0) return;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.setTransform(1, 0, 0, 1, 0, 0); // Reset
            ctx.scale(dpr, dpr);
        }

        function loop() {
            const w = canvas.width / (window.devicePixelRatio||1);
            const h = canvas.height / (window.devicePixelRatio||1);
            ctx.clearRect(0, 0, w, h);

            // CEN√ÅRIO IDENTICO AO JOGO
            const groundY = h - 150;
            const centerX = w / 2;

            ctx.save();
            ctx.fillStyle = '#81C784'; ctx.beginPath(); ctx.ellipse(centerX, groundY+60, w*0.9, 100, 0, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#4CAF50'; ctx.lineWidth = 10; ctx.stroke();

            // POSICIONA BONECO
            ctx.translate(centerX, groundY);
            const s = (avatarConfig.scale || 0.22);
            
            if (isAnimating) animTime += 0.1; else animTime = 0;
            const walk = Math.sin(animTime);
            const bob = Math.abs(Math.sin(animTime)) * 10;
            const breathe = Math.sin(animTime * 0.5) * 0.05;

            LAYER_ORDER.forEach(key => {
                if (hiddenParts[key]) return;
                const img = images[key];
                const cfg = avatarConfig.parts[key];

                if (!img || img.isMissing) {
                    if(['tronco','cabeca'].includes(key)) {
                        ctx.save(); ctx.translate(cfg.x*s, cfg.y*s); 
                        ctx.fillStyle='rgba(255,255,255,0.3)'; ctx.fillRect(-10,-10,20,20); 
                        ctx.restore();
                    }
                    return; 
                }

                let animX = 0, animY = 0, animRot = 0;
                
                if (isAnimating) {
                     if (key === 'arma_frente' || key === 'escudo_frente') {
                        const parent = avatarConfig.parts['braco_frente'];
                        const pRot = -walk * 0.6;
                        const relX = (cfg.x - parent.x)*s; const relY = (cfg.y - parent.y)*s;
                        const rotX = relX * Math.cos(pRot) - relY * Math.sin(pRot);
                        const rotY = relX * Math.sin(pRot) + relY * Math.cos(pRot);
                        
                        ctx.save();
                        ctx.translate((parent.x*s) + rotX, ((parent.y*s) - (bob*s) + rotY));
                        ctx.rotate(pRot);
                        ctx.drawImage(img, -img.width * s * cfg.pivX, -img.height * s * cfg.pivY, img.width*s, img.height*s);
                        if(key === activePart) desenhaGizmo(ctx, img, s, cfg);
                        ctx.restore();
                        return;
                    }
                    if (key === 'escudo_tras') {
                        const parent = avatarConfig.parts['braco_tras'];
                        const pRot = walk * 0.6;
                        const relX = (cfg.x - parent.x)*s; const relY = (cfg.y - parent.y)*s;
                        const rotX = relX * Math.cos(pRot) - relY * Math.sin(pRot);
                        const rotY = relX * Math.sin(pRot) + relY * Math.cos(pRot);
                        
                        ctx.save();
                        ctx.translate((parent.x*s) + rotX, ((parent.y*s) - (bob*s) + rotY));
                        ctx.rotate(pRot);
                        ctx.filter = "brightness(0.7)";
                        ctx.drawImage(img, -img.width * s * cfg.pivX, -img.height * s * cfg.pivY, img.width*s, img.height*s);
                        ctx.filter = "none";
                        if(key === activePart) desenhaGizmo(ctx, img, s, cfg);
                        ctx.restore();
                        return;
                    }
                    if (key.includes('perna')) { animY = -bob; animRot = (key.includes('frente') ? walk : -walk) * 0.5; }
                    else if (key.includes('braco')) { animY = -bob; animRot = (key.includes('frente') ? -walk : walk) * 0.6; }
                    else if (key === 'capa') { animY = -bob; animRot = -0.1 + Math.sin(animTime * 0.6) * 0.05; }
                    else if (['cabeca', 'rosto', 'mascara', 'cabelo'].includes(key)) { animY = -bob + (breathe * 5); animRot = breathe * 0.2; }
                    else { animY = -bob; }
                }

                ctx.save();
                ctx.translate((cfg.x*s) + (animX*s), (cfg.y*s) + (animY*s));
                ctx.rotate(animRot);
                if (key.includes('tras') || key === 'capa') ctx.filter = "brightness(0.7)";
                
                ctx.drawImage(img, -img.width * s * cfg.pivX, -img.height * s * cfg.pivY, img.width * s, img.height * s);
                ctx.filter = "none";
                
                if (key === activePart) desenhaGizmo(ctx, img, s, cfg);
                
                ctx.restore();
            });

            ctx.restore();
            requestAnimationFrame(loop);
        }

        function desenhaGizmo(ctx, img, s, cfg) {
            const w = img.width * s;
            const h = img.height * s;
            ctx.fillStyle = '#FF5722'; ctx.beginPath(); ctx.arc(0,0, 4, 0, Math.PI*2); ctx.fill(); // Piv√¥
            ctx.strokeStyle = '#FFC107'; ctx.lineWidth = 2;
            ctx.strokeRect(-w * cfg.pivX, -h * cfg.pivY, w, h); // Box
        }

        init();
    </script>
</body>
</html>
