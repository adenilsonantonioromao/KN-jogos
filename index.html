<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, setDoc, updateDoc, increment, collection, query, orderBy, limit, onSnapshot, arrayUnion, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIR7CqYYvMZVQxtO67JCQoJ3OLT1cvAx8",
            authDomain: "kn-jogos.firebaseapp.com",
            projectId: "kn-jogos",
            storageBucket: "kn-jogos.firebasestorage.app",
            messagingSenderId: "273132829744",
            appId: "1:273132829744:web:a03e85b80ffabfa24101f5",
            measurementId: "G-CX4Z8R1S6F"
        };

        const app = initializeApp(firebaseConfig);
        
        try {
            const appCheck = initializeAppCheck(app, {
                provider: new ReCaptchaV3Provider('6Lc5vjgsAAAAANx2ia8s_Fh0_KS0_YNaAlSIYpJC'),
                isTokenAutoRefreshEnabled: true
            });
        } catch(e) { console.warn("App Check Warn:", e); }

        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;
        let globalStats = {}; 
        let userStats = {}; 
        let userPointsToday = {};
        let JOGOS_CONFIG = [];
        let NOTICIAS_CONFIG = [];
        let unsubscribeMsg = null;

        // V√°riaveis do Feed
        let feedGlobal = [];
        let paginaAtualFeed = 1;
        const ITEMS_POR_PAGINA = 5;

        const urlParams = new URLSearchParams(window.location.search);
        const refID = urlParams.get('ref');
        if (refID) sessionStorage.setItem('kn_referrer', refID);

        document.getElementById('btn-login').addEventListener('click', () => { signInWithPopup(auth, provider).catch(alert); });

        // --- FUN√á√ïES DE SUPORTE ---

        async function registrarExtrato(userId, valor, motivo, tipo = "FICHA") {
            try {
                await addDoc(collection(db, "users", userId, "extrato"), {
                    data: new Date(), valor: valor, motivo: motivo, tipo: tipo, serial: `${tipo}-${Date.now().toString(36)}`
                });
            } catch(e) {}
        }

        async function carregarUsuario(user) {
            try {
                const userRef = doc(db, "users", user.uid);
                let snap = await getDoc(userRef);
                if (!snap.exists()) {
                    await setDoc(userRef, { 
                        nome: user.displayName, email: user.email, foto: user.photoURL, fichas: 5, 
                        pontuacaoTotal: 0, recordes: {}, jogosJogados: {}, historicoIndicacoes: [],
                        dataInscricao: new Date().toISOString() 
                    });
                    const referrerID = sessionStorage.getItem('kn_referrer');
                    if (referrerID && referrerID !== user.uid) {
                        try { 
                            await updateDoc(doc(db, "users", referrerID), { fichas: increment(25), historicoIndicacoes: arrayUnion(user.uid) });
                            registrarExtrato(referrerID, 25, "Indica√ß√£o", "FICHA");
                        } catch (e) {}
                    }
                    snap = await getDoc(userRef);
                }
                const data = snap.data();
                userStats = data.jogosJogados || {};
                
                if (!data.apelido) abrirModalApelido(true);
                else document.getElementById('user-name').innerText = data.apelido;
                document.getElementById('user-photo').src = user.photoURL;
                document.getElementById('user-fichas').innerText = data.fichas;

                const hoje = new Date().toLocaleDateString('pt-BR');
                if(data.dataUltimoDiario === hoje) {
                    document.getElementById('user-pontos-diario').innerText = data.scoreDiario || 0;
                    userPointsToday = data.pontosHojePorJogo || {};
                } else {
                    document.getElementById('user-pontos-diario').innerText = 0;
                    userPointsToday = {};
                }
            } catch(e) { console.error("Erro perfil:", e); }
        }

        // --- FILTROS ---
        window.carregarFiltros = function(id) {
            const select = document.getElementById(id);
            if(!select) return;
            while (select.options.length > 1) { select.remove(1); }
            const tagsUnicas = new Set();
            JOGOS_CONFIG.forEach(j => { if (j.tags && Array.isArray(j.tags)) j.tags.forEach(tag => tagsUnicas.add(tag)); else if (j.tag) tagsUnicas.add(j.tag); });
            Array.from(tagsUnicas).sort().forEach(tag => { const option = document.createElement('option'); option.value = tag; option.innerText = tag; select.appendChild(option); });
        }

        window.filtrarJogos = function() {
            const select = document.getElementById('filter-tags');
            if(!select) return;
            const tagSelecionada = select.value;
            let listaFinal = [...JOGOS_CONFIG];
            if (tagSelecionada !== 'all') { listaFinal = listaFinal.filter(j => { let tags = j.tags && Array.isArray(j.tags) ? j.tags : (j.tag ? [j.tag] : []); return tags.includes(tagSelecionada); }); }
            listaFinal.sort((a,b) => (globalStats[b.id] || 0) - (globalStats[a.id] || 0));
            const container = document.getElementById('lista-populares');
            if (listaFinal.length === 0) { container.innerHTML = "<p style='grid-column: 1/-1; color:#999;'>Nenhum jogo.</p>"; }
            else { container.innerHTML = listaFinal.map(j => criarCardComContador(j)).join(''); }
        }

        window.filtrarFavoritos = function() {
            const select = document.getElementById('filter-tags-fav');
            if(!select) return;
            const tagSelecionada = select.value;
            let listaFinal = JOGOS_CONFIG.filter(j => (userStats[j.id] || 0) > 0);
            if (tagSelecionada !== 'all') { listaFinal = listaFinal.filter(j => { let tags = j.tags && Array.isArray(j.tags) ? j.tags : (j.tag ? [j.tag] : []); return tags.includes(tagSelecionada); }); }
            listaFinal.sort((a,b) => (userStats[b.id] || 0) - (userStats[a.id] || 0));
            const container = document.getElementById('lista-favoritos');
            if (listaFinal.length === 0) { container.innerHTML = "<p style='grid-column: 1/-1; color:#999;'>Sem favoritos.</p>"; }
            else { container.innerHTML = listaFinal.map(j => criarCardFavorito(j, userStats[j.id])).join(''); }
        }

        // --- CARDS HTML ---
        function criarCardComContador(jogo) {
            const img = `capas/${jogo.img}`;
            const url = `jogos/${(jogo.arquivo.startsWith('jogos/') ? jogo.arquivo.substring(6) : jogo.arquivo).replace(/^\//,'')}`;
            const plays = globalStats[jogo.id] || 0;
            const ptsHoje = userPointsToday[jogo.id] || 0;
            const ptsClass = ptsHoje > 0 ? "color:#4CAF50;" : "color:#ccc;";
            return `<div class="card-grid" onclick="iniciarJogo('${url}', '${jogo.id}')"><div class="card-grid-thumb" style="background-image: url('${img}');"></div><div class="card-overlay"><span class="play-icon-overlay">‚ñ∂</span></div><div class="card-grid-info"><span>üî• ${plays} Plays</span><span style="${ptsClass}">üìÖ Hoje: ${ptsHoje}</span></div></div>`;
        }

        function criarCardFavorito(jogo, count) {
            const img = `capas/${jogo.img}`;
            const url = `jogos/${(jogo.arquivo.startsWith('jogos/') ? jogo.arquivo.substring(6) : jogo.arquivo).replace(/^\//,'')}`;
            const ptsHoje = userPointsToday[jogo.id] || 0;
            const ptsClass = ptsHoje > 0 ? "color:#A5D6A7;" : "color:#ccc;";
            return `<div class="card-grid" onclick="iniciarJogo('${url}', '${jogo.id}')"><div class="card-grid-thumb" style="background-image: url('${img}');"></div><div class="card-overlay"><span class="play-icon-overlay">‚ñ∂</span></div><div class="card-grid-info" style="background: rgba(0,0,100,0.85);"><span>‚ù§Ô∏è Voc√™: ${count}x</span><span style="${ptsClass}">üìÖ Hoje: ${ptsHoje}</span></div></div>`;
        }

        // --- SISTEMA DE FEED (NOVIDADES + JOGOS) CORRIGIDO ---
        async function carregarFeedMisto() {
            try {
                // 1. Carrega Not√≠cias
                const snapNews = await getDocs(collection(db, "listaNoticias"));
                NOTICIAS_CONFIG = [];
                snapNews.forEach(d => NOTICIAS_CONFIG.push({...d.data(), tipoItem: 'news'}));

                // 2. Mescla com Jogos (TRATAMENTO DE DADOS ANTIGOS)
                const jogosPermitidos = JOGOS_CONFIG.filter(j => !j.ocultarNaHome).map(j => ({
                    ...j, 
                    tipoItem: 'jogo', 
                    // Se o jogo n√£o tiver data (antigo), usa a data de hoje para aparecer no topo, ou uma data fixa
                    data: j.dataInclusao || new Date().toISOString()
                }));
                
                feedGlobal = [...NOTICIAS_CONFIG, ...jogosPermitidos];
                
                // Ordena do mais recente pro mais antigo
                feedGlobal.sort((a,b) => new Date(b.data) - new Date(a.data));

                document.getElementById('loading-feed').style.display = 'none';
                
                const pagination = document.getElementById('feed-pagination');
                if(pagination) pagination.style.display = feedGlobal.length > ITEMS_POR_PAGINA ? 'flex' : 'none';
                
                renderizarPaginaFeed(1);
            } catch(e) { console.error("Feed error:", e); }
        }

        window.mudarPaginaFeed = function(direcao) {
            const totalPaginas = Math.ceil(feedGlobal.length / ITEMS_POR_PAGINA);
            const novaPagina = paginaAtualFeed + direcao;
            if (novaPagina >= 1 && novaPagina <= totalPaginas) {
                renderizarPaginaFeed(novaPagina);
            }
        }

        function renderizarPaginaFeed(pagina) {
            paginaAtualFeed = pagina;
            const elPag = document.getElementById('page-number');
            if(elPag) elPag.innerText = `P√°gina ${pagina}`;
            
            const start = (pagina - 1) * ITEMS_POR_PAGINA;
            const end = start + ITEMS_POR_PAGINA;
            const itensDaPagina = feedGlobal.slice(start, end);
            const container = document.getElementById('lista-feed');
            
            if(!container) return;

            container.innerHTML = itensDaPagina.map(item => {
                if(item.tipoItem === 'jogo') {
                    // Renderiza Card de Jogo
                    const img = `capas/${item.img}`;
                    const url = `jogos/${(item.arquivo.startsWith('jogos/') ? item.arquivo.substring(6) : item.arquivo).replace(/^\//,'')}`;
                    return `<div class="game-card"><div class="game-thumb" style="background-image: url('${img}');"></div><div class="game-info"><div><h3 style="margin:0; font-size:1.1rem;">üéÆ ${item.nome}</h3><p style="margin:5px 0; font-size:0.8rem; color:#666;">${item.desc}</p></div><button class="play-btn" onclick="iniciarJogo('${url}', '${item.id}')">JOGAR</button></div></div>`;
                } else {
                    // Renderiza Card de Not√≠cia
                    const imgHtml = item.imagem ? `<div class="news-img" style="background-image: url('${item.imagem}');"></div>` : '';
                    const dataF = new Date(item.data).toLocaleDateString('pt-BR');
                    return `<div class="news-card">${imgHtml}<div class="news-body"><span class="news-date">üìÖ ${dataF}</span><div class="news-title">${item.titulo}</div><div class="news-text">${item.texto}</div></div></div>`;
                }
            }).join('');
        }

        function renderizarTodosJogos() {
            carregarFeedMisto(); // Carrega Novidades + Jogos
            carregarFiltros('filter-tags'); filtrarJogos(); 
            carregarFiltros('filter-tags-fav'); filtrarFavoritos();
        }

        // --- DADOS GERAIS ---
        async function carregarBanners() {
            try {
                const querySnapshot = await getDocs(collection(db, "listaBanners"));
                let banners = [];
                querySnapshot.forEach((doc) => banners.push(doc.data()));
                if(banners.length === 0) return;
                banners.sort((a, b) => a.ordem - b.ordem);
                const container = document.getElementById('carousel-container');
                if(!container) return;
                container.style.display = 'block';
                container.innerHTML = '<div class="carousel-dots" id="carousel-dots"></div>';
                const newDots = document.getElementById('carousel-dots');
                banners.forEach((b, index) => {
                    const slide = document.createElement('div');
                    slide.className = `carousel-slide ${index === 0 ? 'active' : ''}`;
                    slide.style.backgroundImage = `url('banners/${b.arquivo}')`;
                    if (b.link) {
                        slide.classList.add('clickable');
                        slide.onclick = () => {
                            if (b.link === '#share') abrirModalShare();
                            else if (b.link.startsWith('#')) {
                                const btn = document.querySelector(`.nav-btn[onclick*="${b.link.replace('#tab-', '')}"]`);
                                if (btn) btn.click();
                            } else window.open(b.link, '_blank');
                        };
                    }
                    container.appendChild(slide);
                    const dot = document.createElement('div');
                    dot.className = `dot ${index === 0 ? 'active' : ''}`;
                    dot.onclick = () => mudarSlide(index);
                    if(newDots) newDots.appendChild(dot);
                });
                iniciarRotacaoBanners(banners.length);
            } catch (e) {}
        }

        async function carregarListaDeJogos() {
            try {
                const querySnapshot = await getDocs(collection(db, "listaJogos"));
                JOGOS_CONFIG = [];
                querySnapshot.forEach((doc) => { JOGOS_CONFIG.push(doc.data()); });
            } catch (e) {}
        }

        async function carregarStatsGlobais() {
            const snap = await getDoc(doc(db, "config", "gameStats"));
            if(snap.exists()) globalStats = snap.data();
        }

        function iniciarMonitoramentoMensagens(user) {
            const listaEl = document.getElementById('lista-mensagens');
            if (!listaEl) return;
            const msgsRef = collection(db, "users", user.uid, "mensagens");
            const q = query(msgsRef, orderBy("data", "desc"), limit(20));
            unsubscribeMsg = onSnapshot(q, (snapshot) => {
                const badgeEl = document.getElementById('inbox-badge');
                let naoLidas = 0;
                let html = "";
                if (snapshot.empty) { listaEl.innerHTML = '<div class="empty-inbox">Vazio.</div>'; if(badgeEl) badgeEl.style.display = 'none'; return; }
                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    if (!msg.lida) naoLidas++;
                    let dataF = "Agora";
                    try { dataF = msg.data.toDate().toLocaleDateString('pt-BR'); } catch(e){}
                    html += `<li class="msg-item ${msg.lida ? '' : 'unread'}"><div class="msg-header"><span class="msg-title">${msg.titulo}</span><span class="msg-date">${dataF}</span></div><div class="msg-body">${msg.corpo}</div>${!msg.lida ? `<button class="msg-btn-read" onclick="marcarMensagemLida('${doc.id}')">‚úî Lida</button>` : ''}</li>`;
                });
                listaEl.innerHTML = html;
                if (badgeEl) { badgeEl.innerText = naoLidas; badgeEl.style.display = naoLidas > 0 ? 'flex' : 'none'; }
            }, (error) => { console.warn("Inbox:", error); });
        }

        // --- AUTH START ---
        onAuthStateChanged(auth, async (user) => {
            const loginScreen = document.getElementById('login-screen');
            const appContainer = document.getElementById('app-container');
            const splash = document.getElementById('splash-screen');
            try {
                if (user) {
                    currentUser = user;
                    loginScreen.style.display = 'none';
                    appContainer.style.display = 'block';
                    const meuLink = `${window.location.origin}${window.location.pathname}?ref=${user.uid}`;
                    if(document.getElementById('share-link-input')) document.getElementById('share-link-input').value = meuLink;
                    await carregarUsuario(user);
                    try { iniciarMonitoramentoMensagens(user); } catch(e) {}
                    await carregarListaDeJogos(); 
                    await carregarBanners(); 
                    await carregarStatsGlobais();
                    renderizarTodosJogos();
                } else { if(unsubscribeMsg) unsubscribeMsg(); loginScreen.style.display = 'flex'; appContainer.style.display = 'none'; }
            } catch (error) { console.error("Erro auth:", error); loginScreen.style.display = 'flex'; } 
            finally { if(splash) splash.style.display = 'none'; }
        });

        // --- UI ---
        let currentSlide = 0;
        function iniciarRotacaoBanners(total) {
            if(total <= 1) return;
            setInterval(() => { let next = currentSlide + 1; if(next >= total) next = 0; mudarSlide(next); }, 5000);
        }
        function mudarSlide(index) {
            const slides = document.querySelectorAll('.carousel-slide');
            const dots = document.querySelectorAll('.dot');
            if(slides.length === 0) return;
            slides[currentSlide].classList.remove('active');
            dots[currentSlide].classList.remove('active');
            currentSlide = index;
            slides[currentSlide].classList.add('active');
            dots[currentSlide].classList.add('active');
        }

        window.mudarAba = async function(abaID, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + abaID).classList.add('active');
            btn.classList.add('active');
            if(abaID === 'rank') carregarRanking();
            if(abaID === 'populares') { carregarFiltros('filter-tags'); filtrarJogos(); }
            if(abaID === 'favoritos') { carregarFiltros('filter-tags-fav'); filtrarFavoritos(); }
        }

        window.abrirModalInbox = function() { document.getElementById('inbox-modal').style.display = 'flex'; }
        window.fecharModalInbox = function() { document.getElementById('inbox-modal').style.display = 'none'; }
        window.abrirModalApelido = function(obrigatorio) { document.getElementById('nickname-modal').style.display = 'flex'; if (!obrigatorio) document.getElementById('input-apelido').value = document.getElementById('user-name').innerText; if(document.getElementById('close-nick-modal')) document.getElementById('close-nick-modal').style.display = obrigatorio ? 'none' : 'block'; }
        window.fecharModalApelido = function() { document.getElementById('nickname-modal').style.display = 'none'; }
        window.abrirModalShare = function() { document.getElementById('share-modal').style.display = 'flex'; }
        window.fecharModalShare = function() { document.getElementById('share-modal').style.display = 'none'; }

        window.marcarMensagemLida = async function(msgId) { if(!currentUser) return; await updateDoc(doc(db, "users", currentUser.uid, "mensagens", msgId), { lida: true }); }
        window.salvarApelido = async function() { const nick = document.getElementById('input-apelido').value.trim(); if (nick.length < 3) return alert("M√≠nimo 3 letras."); await updateDoc(doc(db, "users", currentUser.uid), { apelido: nick }); document.getElementById('user-name').innerText = nick; fecharModalApelido(); if(document.getElementById('tab-rank').classList.contains('active')) carregarRanking(); }
        window.copiarLinkGanharFichas = async function() {
            const input = document.getElementById('share-link-input');
            if(!input) return; input.select(); navigator.clipboard.writeText(input.value);
            if (currentUser) {
                const userRef = doc(db, "users", currentUser.uid);
                const data = (await getDoc(userRef)).data();
                const hoje = new Date().toLocaleDateString('pt-BR');
                if (data.ultimoResgateShare !== hoje) {
                    await updateDoc(userRef, { fichas: increment(10), ultimoResgateShare: hoje });
                    document.getElementById('user-fichas').innerText = (data.fichas||0) + 10;
                    registrarExtrato(currentUser.uid, 10, "B√¥nus Di√°rio", "FICHA");
                    mostrarNotificacao("+10 Fichas! üéâ");
                } else mostrarNotificacao("J√° resgatou hoje ‚úÖ");
            }
            setTimeout(fecharModalShare, 2000);
        }

        window.iniciarJogo = async function(urlArquivo, idJogo) {
            if(!currentUser) return;
            const userRef = doc(db, "users", currentUser.uid);
            const snap = await getDoc(userRef);
            if ((snap.data().fichas || 0) < 1) { mostrarNotificacao("üö´ Sem fichas!"); return; }
            await updateDoc(userRef, { fichas: increment(-1), [`jogosJogados.${idJogo}`]: increment(1) });
            setDoc(doc(db, "config", "gameStats"), { [idJogo]: increment(1) }, { merge: true });
            document.getElementById('user-fichas').innerText = (snap.data().fichas || 0) - 1;
            registrarExtrato(currentUser.uid, -1, `Jogou: ${idJogo}`, "FICHA");
            window.jogoAtualID = idJogo;
            const modal = document.getElementById('game-modal');
            const iframe = document.getElementById('game-frame');
            if(modal && iframe) { modal.style.display = 'flex'; iframe.src = urlArquivo; }
        }

        window.reiniciarJogo = async function() {
            if(!currentUser) return;
            if(!confirm("‚ö†Ô∏è JOGAR NOVAMENTE: Custo 1 Ficha ü™ô")) return;
            const userRef = doc(db, "users", currentUser.uid);
            const snap = await getDoc(userRef);
            if ((snap.data().fichas || 0) < 1) { mostrarNotificacao("üö´ Sem fichas!"); return; }
            await updateDoc(userRef, { fichas: increment(-1), [`jogosJogados.${window.jogoAtualID}`]: increment(1) });
            setDoc(doc(db, "config", "gameStats"), { [window.jogoAtualID]: increment(1) }, { merge: true });
            document.getElementById('user-fichas').innerText = (snap.data().fichas || 0) - 1;
            registrarExtrato(currentUser.uid, -1, `Rejogou: ${window.jogoAtualID}`, "FICHA");
            const iframe = document.getElementById('game-frame');
            if(iframe) iframe.src = iframe.src;
            mostrarNotificacao("üîÑ Recarregando...");
        }

        window.fecharJogo = function() { document.getElementById('game-modal').style.display = 'none'; document.getElementById('game-frame').src = ""; location.reload(); }
        window.ativarTelaCheia = function() { const iframe = document.getElementById('game-frame'); if (iframe) { if (iframe.requestFullscreen) iframe.requestFullscreen(); else if (iframe.webkitRequestFullscreen) iframe.webkitRequestFullscreen(); } }
        window.rolarAteMim = function() { const el = document.getElementById('meu-rank'); if(el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); el.style.border = "3px solid red"; setTimeout(() => el.style.border = "2px solid var(--primary)", 2000); } else alert("Voc√™ ainda n√£o pontuou hoje!"); }

        window.addEventListener('message', async function(event) {
            let pontos = 0; let isGameOver = false;
            if (event.data && event.data.type === 'GAME_OVER') { pontos = parseInt(event.data.score) || 0; isGameOver = true; }
            else if (typeof event.data === 'number') { pontos = parseInt(event.data); isGameOver = true; }
            if (!isGameOver) { if (event.data === 'RESTART_REQUEST' || (event.data && event.data.type === 'RESTART_REQUEST')) reiniciarJogo(); return; }

            mostrarNotificacao(`Fim! Pontos: ${pontos}`);
            if (!currentUser) return;

            try { const spanPts = document.getElementById('user-pontos-diario'); if(spanPts) spanPts.innerText = (parseInt(spanPts.innerText)||0) + pontos; } catch(e) {}

            const userRef = doc(db, "users", currentUser.uid);
            try {
                const data = (await getDoc(userRef)).data();
                let updates = { pontuacaoTotal: increment(pontos) };
                const hoje = new Date().toLocaleDateString('pt-BR');
                const d = new Date(); d.setHours(0,0,0,0); d.setDate(d.getDate()+3-(d.getDay()+6)%7);
                const sem = 1+Math.round(((d.getTime()-new Date(d.getFullYear(),0,4).getTime())/86400000-3+(new Date(d.getFullYear(),0,4).getDay()+6)%7)/7);
                const mes = `${d.getMonth()+1}/${d.getFullYear()}`;

                if (data.dataUltimoDiario === hoje) {
                    updates.scoreDiario = increment(pontos);
                } else { 
                    updates.scoreDiario = pontos; 
                    updates.dataUltimoDiario = hoje;
                    updates.pontosHojePorJogo = {}; 
                }
                
                let mapAtual = data.dataUltimoDiario === hoje ? (data.pontosHojePorJogo || {}) : {};
                mapAtual[window.jogoAtualID] = (mapAtual[window.jogoAtualID] || 0) + pontos;
                updates.pontosHojePorJogo = mapAtual;

                if (data.dataUltimoSemanal === sem) updates.scoreSemanal = increment(pontos); else { updates.scoreSemanal = pontos; updates.dataUltimoSemanal = sem; }
                if (data.dataUltimoMensal === mes) updates.scoreMensal = increment(pontos); else { updates.scoreMensal = pontos; updates.dataUltimoMensal = mes; }
                
                let recordes = data.recordes || {};
                if (pontos > (recordes[window.jogoAtualID] || 0)) { recordes[window.jogoAtualID] = pontos; updates.recordes = recordes; mostrarNotificacao(`üèÜ NOVO RECORDE!`); }
                registrarExtrato(currentUser.uid, pontos, `Score: ${window.jogoAtualID}`, "PONTO");
                await updateDoc(userRef, updates);
            } catch (e) { console.error("Erro ao salvar pontos:", e); }
        });

        function mostrarNotificacao(msg) {
            const el = document.getElementById('notificacao');
            if(el) { el.innerText = msg; el.style.display = 'block'; setTimeout(() => el.style.display = 'none', 4000); }
        }

        // --- RANKING (COM FUN√á√ÉO RECUPERADA) ---
        async function carregarRanking() {
            const list = document.getElementById('lista-rank');
            if(!list) return;
            list.innerHTML = "";
            const loading = document.getElementById('loading-rank');
            if(loading) loading.style.display = 'block';
            try {
                const q = query(collection(db, "users"), orderBy("scoreDiario", "desc"), limit(50));
                const querySnapshot = await getDocs(q);
                if(loading) loading.style.display = 'none';
                let rank = 1;
                const hoje = new Date().toLocaleDateString('pt-BR');

                querySnapshot.forEach((docSnap) => {
                    const u = docSnap.data();
                    const isMe = docSnap.id === currentUser.uid;
                    const nome = u.apelido || u.nome.split(' ')[0];
                    const pontos = (u.dataUltimoDiario === hoje) ? (u.scoreDiario || 0) : 0;
                    list.innerHTML += `<li id="${isMe ? 'meu-rank' : ''}" class="rank-item ${isMe ? 'me' : ''}"><div class="rank-pos">#${rank}</div><div class="rank-user"><img src="${u.foto}"><div><strong>${nome}</strong></div></div><div class="rank-score">${pontos}</div></li>`;
                    rank++;
                });
            } catch (error) { 
                console.error(error); 
                if(loading) loading.style.display = 'none';
                list.innerHTML = "<li>Erro ao carregar ranking.</li>";
            }
        }
    </script>
</body>
</html>
