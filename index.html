<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KN Jogos Online</title>
    
    <!-- CSS DO PROJETO -->
    <style>
        /* --- GERAL --- */
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: #121212; color: #fff; overflow-x: hidden; }
        
        /* --- TELA DE LOGIN (SEU ESTILO ORIGINAL) --- */
        #login-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, #2196F3, #9C27B0); 
            display: flex; /* Flex para centralizar */
            flex-direction: column; justify-content: center; align-items: center; z-index: 2000; 
        }
        .login-box { 
            background: white; padding: 30px; border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 85%; max-width: 350px; 
            text-align: center; color: #333;
        }
        .btn-google {
            background: #fff; border: 1px solid #ccc; color: #555; width: 100%; padding: 12px;
            border-radius: 8px; font-weight: bold; cursor: pointer; display: flex;
            align-items: center; justify-content: center; gap: 10px; font-size: 16px;
            margin-top: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- CABE√áALHO --- */
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #1f1f1f; border-bottom: 2px solid #333; }
        .logo { font-weight: bold; font-size: 24px; color: #00ff88; text-transform: uppercase; letter-spacing: 2px; }
        
        .user-area { display: flex; align-items: center; gap: 15px; }
        .wallet { background: #333; padding: 5px 15px; border-radius: 20px; font-weight: bold; color: gold; display: flex; align-items: center; gap: 5px; }
        .user-pic { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #00ff88; }

        /* --- √çCONE INBOX (NOVO) --- */
        #btn-inbox { cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; }
        #btn-inbox span { font-size: 26px; }
        #inbox-badge { 
            display: none; position: absolute; top: -5px; right: -5px; 
            background: #ff0044; color: white; border-radius: 50%; 
            width: 18px; height: 18px; font-size: 11px; font-weight: bold;
            text-align: center; line-height: 18px; border: 2px solid #1f1f1f; 
        }

        /* --- APP PRINCIPAL --- */
        #app { display: none; }
        
        .links-bar { display: flex; justify-content: center; gap: 20px; padding: 10px; background: #1a1a1a; }
        .links-bar a { color: #aaa; text-decoration: none; font-size: 14px; }
        .links-bar a:hover { color: #fff; }

        /* --- GAMES GRID --- */
        .games-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; padding: 15px; }
        .game-card { background: #222; border-radius: 10px; overflow: hidden; transition: transform 0.2s; cursor: pointer; }
        .game-card:hover { transform: scale(1.05); border: 1px solid #00ff88; }
        .game-thumb { width: 100%; height: 120px; object-fit: cover; }
        .game-info { padding: 10px; text-align: center; }

        /* --- MODAL DO JOGO --- */
        #game-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 3000; flex-direction: column; }
        iframe { width: 100%; flex: 1; border: none; }
        .game-bar { background: #111; padding: 5px; display: flex; justify-content: space-between; align-items: center; color: white; }
        .btn-game-nav { background: #333; color: white; border: 1px solid #555; padding: 5px 10px; cursor: pointer; font-size: 12px; }
        .btn-close { background: #d32f2f; border-color: #b71c1c; }

        /* --- MODAL DE INBOX (MENSAGENS) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 4000;
            display: flex; justify-content: center; align-items: center;
        }
        .inbox-container {
            background: #1e1e1e; width: 90%; max-width: 450px; height: 70vh;
            border-radius: 12px; border: 1px solid #444; display: flex; flex-direction: column;
            box-shadow: 0 0 25px rgba(0,255,136,0.1);
        }
        .inbox-header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #252525; border-radius: 12px 12px 0 0; }
        .inbox-list { flex: 1; overflow-y: auto; padding: 10px; }
        .msg-card { background: #2a2a2a; margin-bottom: 10px; padding: 12px; border-radius: 6px; border-left: 4px solid #555; position: relative; cursor: pointer; }
        .msg-card.unread { border-left: 4px solid #00ff88; background: #2f3530; }
        .msg-top { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .msg-title { font-weight: bold; color: #fff; font-size: 14px; }
        .msg-date { font-size: 10px; color: #888; }
        .msg-body { font-size: 13px; color: #ccc; line-height: 1.4; margin-right: 25px; }
        .btn-trash { position: absolute; bottom: 8px; right: 8px; background: none; border: none; cursor: pointer; font-size: 16px; opacity: 0.6; }
        
        /* --- NOTIFICA√á√ÉO TOAST --- */
        #notificacao {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: #00ff88; padding: 10px 20px; border-radius: 30px;
            border: 1px solid #00ff88; display: none; z-index: 5000; font-weight: bold;
        }
    </style>

    <!-- MAPA DE IMPORTA√á√ÉO (React/Three) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "three": "https://esm.sh/three@0.160.0",
        "@react-three/fiber": "https://esm.sh/@react-three/fiber@8.15.16?external=react,react-dom,three",
        "@react-three/drei": "https://esm.sh/@react-three/drei@9.99.0?external=react,react-dom,three,@react-three/fiber"
      }
    }
    </script>
</head>
<body>

    <!-- 1. TELA DE LOGIN (Seu Design) -->
    <div id="login-screen">
        <div class="login-box">
            <h1 style="margin:0; color:#2196F3;">KN JOGOS</h1>
            <p style="color:#666;">Entre para competir!</p>
            <button id="btn-google" class="btn-google">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
                Entrar com Google
            </button>
        </div>
    </div>

    <!-- 2. APP PRINCIPAL -->
    <div id="app">
        <header>
            <div class="logo">KN</div>
            <div class="user-area">
                <!-- √çcone Inbox -->
                <div id="btn-inbox" title="Mensagens">
                    <span>üì©</span>
                    <div id="inbox-badge">0</div>
                </div>
                <!-- Carteira -->
                <div class="wallet">
                    ü™ô <span id="user-fichas">0</span>
                </div>
                <!-- Foto -->
                <img id="user-photo" class="user-pic" src="" alt="User">
            </div>
        </header>

        <div class="links-bar">
            <a href="ranking.html">üèÜ Ranking</a>
            <a href="#" id="btn-share-link">üîó Indicar Amigo</a>
            <a href="admin.html" id="link-admin" style="display:none;">‚öôÔ∏è Admin</a>
        </div>

        <!-- Banner -->
        <div style="width: 100%; height: 200px; background: #333; overflow: hidden; position: relative;">
             <img src="banners/novosjogos.jpg" style="width:100%; height:100%; object-fit: cover;" onerror="this.src='https://via.placeholder.com/1200x400?text=KN+JOGOS'">
        </div>

        <h3 style="padding-left: 15px; margin-top: 20px;">üéÆ Jogos Dispon√≠veis</h3>
        
        <!-- Lista de Jogos -->
        <div class="games-grid" id="games-list"></div>

        <p style="text-align: center; color: #555; font-size: 12px; padding: 20px;">KN Jogos Online ¬© 2025</p>
    </div>

    <!-- 3. MODAL DO JOGO (Com barra de controle) -->
    <div id="game-modal">
        <div class="game-bar">
            <span>Jogando...</span>
            <div>
                <button class="btn-game-nav" onclick="ativarTelaCheia()">[ ] Tela Cheia</button>
                <button class="btn-game-nav" onclick="reiniciarJogo()">üîÑ Reiniciar</button>
                <button class="btn-game-nav btn-close" onclick="fecharJogo()">‚úñ Sair</button>
            </div>
        </div>
        <iframe id="game-frame" src=""></iframe>
    </div>

    <!-- 4. MODAL DE INBOX -->
    <div id="inbox-modal" class="modal-overlay" style="display: none;">
        <div class="inbox-container">
            <div class="inbox-header">
                <h3 style="margin:0; color:#fff;">üì¨ Notifica√ß√µes</h3>
                <button id="close-inbox" style="background:none; border:none; color:#aaa; font-size:24px; cursor:pointer;">‚úñ</button>
            </div>
            <div id="inbox-list" class="inbox-list">
                <p style="text-align: center; color: #888; margin-top: 20px;">Carregando...</p>
            </div>
        </div>
    </div>

    <!-- 5. NOTIFICA√á√ÉO FLUTUANTE -->
    <div id="notificacao"></div>

    <!-- L√ìGICA DO SISTEMA -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, onSnapshot, collection, serverTimestamp, addDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURA√á√ÉO FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyBIR7CqYYvMZVQxtO67JCQoJ3OLT1cvAx8",
          authDomain: "kn-jogos.firebaseapp.com",
          projectId: "kn-jogos",
          storageBucket: "kn-jogos.firebasestorage.app",
          messagingSenderId: "273132829744",
          appId: "1:273132829744:web:a03e85b80ffabfa24101f5",
          measurementId: "G-CX4Z8R1S6F"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        window.jogoAtualID = null; // Tornei global para usar nas fun√ß√µes window.

        // --- VERIFICA√á√ÉO DE INDICA√á√ÉO (Ref Link) ---
        const urlParams = new URLSearchParams(window.location.search);
        const refLink = urlParams.get('ref');
        if (refLink) {
            console.log("üîó Indica√ß√£o:", refLink);
            sessionStorage.setItem('kn_indicador', refLink);
        }

        // --- LOGIN ---
        document.getElementById('btn-google').addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(err => alert("Erro: " + err.message));
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                document.getElementById('user-photo').src = user.photoURL;

                // Admin check
                if(user.email === "adenilsonantonioromao@gmail.com" || user.email === "knjogos@gmail.com") {
                    document.getElementById('link-admin').style.display = 'inline';
                }

                await carregarUsuario(user);
                iniciarInbox(user.uid);
                carregarJogos();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        async function carregarUsuario(user) {
            const userRef = doc(db, 'users', user.uid);
            const snap = await getDoc(userRef);

            if (!snap.exists()) {
                // NOVO USU√ÅRIO + INDICA√á√ÉO
                const indicadorId = sessionStorage.getItem('kn_indicador');
                if (indicadorId && indicadorId !== user.uid) {
                    processarIndicacao(user.uid, indicadorId);
                    sessionStorage.removeItem('kn_indicador');
                }

                await setDoc(userRef, {
                    nome: user.displayName,
                    email: user.email,
                    foto: user.photoURL,
                    fichas: 10,
                    pontosCampeao: 0,
                    jogosJogados: {}, // Sua estrutura original
                    recordes: {},     // Sua estrutura original
                    scoreDiario: 0, dataUltimoDiario: "",
                    scoreSemanal: 0, dataUltimoSemanal: "",
                    scoreMensal: 0, dataUltimoMensal: "",
                    dataCriacao: serverTimestamp()
                });
                document.getElementById('user-fichas').innerText = "10";
            } else {
                const data = snap.data();
                document.getElementById('user-fichas').innerText = data.fichas;
                // Os resets de data s√£o feitos na hora de salvar o ponto (Lazy)
            }

            onSnapshot(userRef, (doc) => {
                if(doc.exists()) document.getElementById('user-fichas').innerText = doc.data().fichas;
            });
        }

        // --- SISTEMA DE INBOX ---
        function iniciarInbox(userId) {
            const msgsRef = collection(db, 'users', userId, 'mensagens');
            const q = query(msgsRef, orderBy('data', 'desc'));

            onSnapshot(q, (snapshot) => {
                const lista = document.getElementById('inbox-list');
                const badge = document.getElementById('inbox-badge');
                let naoLidas = 0;
                let html = '';

                if (snapshot.empty) {
                    lista.innerHTML = '<p style="text-align:center; padding:20px; color:#666">Vazio.</p>';
                    badge.style.display = 'none';
                    return;
                }

                snapshot.forEach(docSnap => {
                    const msg = docSnap.data();
                    const id = docSnap.id;
                    if (!msg.lida) naoLidas++;
                    
                    let dataStr = 'Hoje';
                    if (msg.data) {
                        const d = msg.data.toDate();
                        dataStr = `${d.getDate()}/${d.getMonth()+1} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
                    }

                    html += `
                        <div class="msg-card ${msg.lida ? '' : 'unread'}" onclick="lerMsg('${userId}', '${id}')">
                            <div class="msg-top">
                                <span class="msg-title">${msg.titulo}</span>
                                <span class="msg-date">${dataStr}</span>
                            </div>
                            <div class="msg-body">${msg.corpo}</div>
                            <button class="btn-trash" onclick="event.stopPropagation(); apagarMsg('${userId}', '${id}')">üóëÔ∏è</button>
                        </div>
                    `;
                });
                lista.innerHTML = html;
                badge.style.display = naoLidas > 0 ? 'block' : 'none';
                badge.innerText = naoLidas > 99 ? '99+' : naoLidas;
            });
        }

        window.lerMsg = async (uid, mid) => {
            await updateDoc(doc(db, 'users', uid, 'mensagens', mid), { lida: true, lidaEm: serverTimestamp() });
        }
        window.apagarMsg = async (uid, mid) => {
            if(confirm("Apagar?")) await deleteDoc(doc(db, 'users', uid, 'mensagens', mid));
        }

        document.getElementById('btn-inbox').addEventListener('click', () => document.getElementById('inbox-modal').style.display = 'flex');
        document.getElementById('close-inbox').addEventListener('click', () => document.getElementById('inbox-modal').style.display = 'none');

        // --- SISTEMA DE COMPARTILHAMENTO E INDICA√á√ÉO ---
        async function processarIndicacao(novoUserId, idAmigo) {
            const amigoRef = doc(db, 'users', idAmigo);
            const snap = await getDoc(amigoRef);
            if(snap.exists()) {
                await updateDoc(amigoRef, { fichas: increment(25) });
                await addDoc(collection(db, 'users', idAmigo, 'mensagens'), {
                    titulo: 'ü§ù Indica√ß√£o!', corpo: 'Amigo cadastrado! +25 Fichas.', data: serverTimestamp(), lida: false
                });
            }
        }

        document.getElementById('btn-share-link').addEventListener('click', async (e) => {
            e.preventDefault();
            const link = `${window.location.origin}${window.location.pathname}?ref=${currentUser.uid}`;
            try {
                await navigator.clipboard.writeText(link);
                mostrarNotificacao("Link copiado! Envie para amigos.");
                registrarShare(currentUser.uid);
            } catch(err) { prompt("Copie seu link:", link); registrarShare(currentUser.uid); }
        });

        async function registrarShare(uid) {
            const userRef = doc(db, 'users', uid);
            const hoje = new Date().toLocaleDateString('pt-BR');
            const snap = await getDoc(userRef);
            if(snap.data().ultimoCompartilhamento !== hoje) {
                await updateDoc(userRef, { fichas: increment(10), ultimoCompartilhamento: hoje });
                await addDoc(collection(db, 'users', uid, 'mensagens'), {
                    titulo: 'üì¢ B√¥nus Share', corpo: 'Compartilhou o link! +10 Fichas.', data: serverTimestamp(), lida: false
                });
            }
        }

        // --- JOGOS (Sua L√≥gica Original) ---
        const MEUS_JOGOS = [
            { id: 'neon', nome: 'Neon Drive', img: 'capas/Neoncap.jpg', url: 'jogos/Neon.html' },
            { id: 'sky',  nome: 'Sky Box',    img: 'capas/Skyboxcap.jpg', url: 'jogos/Skybox.html' },
            { id: 'jurassic', nome: 'Jurassic Run', img: 'capas/jurassiccap.jpg', url: 'jogos/Jurassic.html' }
        ];

        function carregarJogos() {
            const div = document.getElementById('games-list');
            div.innerHTML = '';
            MEUS_JOGOS.forEach(game => {
                const el = document.createElement('div');
                el.className = 'game-card';
                el.innerHTML = `
                    <img src="${game.img}" class="game-thumb" onerror="this.src='https://via.placeholder.com/150'">
                    <div class="game-info">
                        <strong>${game.nome}</strong><br>
                        <span style="color:#00ff88; font-size:12px;">1 Ficha</span>
                    </div>
                `;
                el.onclick = () => window.iniciarJogo(game.url, game.id);
                div.appendChild(el);
            });
        }

        // Fun√ß√µes Globais (window) para manter compatibilidade com seus scripts antigos
        window.iniciarJogo = async function(urlArquivo, idJogo) {
            if(!currentUser) return;
            const userRef = doc(db, "users", currentUser.uid);
            const snap = await getDoc(userRef);
            
            if (snap.data().fichas < 1) { mostrarNotificacao("üö´ Sem fichas!"); return; }
            
            const updates = { fichas: increment(-1) };
            updates[`jogosJogados.${idJogo}`] = increment(1); // Mantive sua estrutura
            
            await updateDoc(userRef, updates);
            // setDoc(doc(db, "config", "gameStats"), { [idJogo]: increment(1) }, { merge: true }); // Opcional se usar gameStats

            window.jogoAtualID = idJogo;
            const modal = document.getElementById('game-modal');
            const i
