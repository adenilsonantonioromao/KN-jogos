<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - KN Jogos</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f9; padding: 20px; max-width: 800px; margin: 0 auto; color: #333; }
        
        #lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #111, #333); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .login-box { background: rgba(255,255,255,0.1); padding: 40px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.2); }
        .login-btn { background: #FF5722; color: white; padding: 15px 30px; font-size: 1.2rem; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; margin-top: 20px; transition: 0.3s; }
        
        #admin-content { display: none; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 15px; background: #ddd; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 0.9rem; color: #666; white-space: nowrap; }
        .tab-btn.active { background: #FF5722; color: white; box-shadow: 0 4px 10px rgba(255, 87, 34, 0.3); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .editor-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-left: 5px solid #FF5722; }
        label { font-weight: bold; font-size: 0.85rem; display: block; margin-top: 15px; color: #555; text-transform: uppercase; }
        input, textarea, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; background: #fafafa; }
        
        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .btn-save { background: #2196F3; color: white; }
        .btn-clear { background: #9E9E9E; color: white; }
        .btn-delete { background: #ff4444; color: white; flex: 0.3; }

        .list-container { margin-top: 40px; }
        .item-list { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 1px solid transparent; }
        .item-list:hover { border-color: #2196F3; transform: translateX(5px); }
        .date-badge { font-size: 0.75rem; color: #666; background: #eee; padding: 2px 8px; border-radius: 10px; margin-top: 4px; display: inline-block; }
        .tag-badge { background: #FF5722; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; margin-top: 2px; display: inline-block; }
        .versao-badge { background: #607D8B; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
    </style>
</head>
<body>

    <div id="lock-screen">
        <div class="login-box">
            <h1 style="margin:0">üîí √Årea Restrita</h1>
            <button class="login-btn" id="btn-login">üîë ENTRAR COM GOOGLE</button>
            <p id="error-msg" style="color:#ff5252; font-weight:bold; margin-top:15px; display:none;"></p>
        </div>
    </div>

    <div id="admin-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>‚öôÔ∏è Painel de Controle</h2>
            <button onclick="sair()" style="width:auto; background:#333; font-size:0.8rem; padding:5px 15px; margin:0; color:white;">Sair</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="mudarAba('jogos')">üéÆ Jogos</button>
            <button class="tab-btn" onclick="mudarAba('noticias')">üì∞ Not√≠cias</button>
            <button class="tab-btn" onclick="mudarAba('banners')">üñºÔ∏è Banners</button>
        </div>

        <div id="status" style="text-align:center; padding:10px; margin-bottom:10px; font-weight:bold; display:none;"></div>

        <!-- CONTE√öDO: JOGOS -->
        <div id="tab-jogos" class="tab-content active">
            <div class="editor-card">
                <h3>Novo/Editar Jogo</h3>
                <label>ID do Jogo (√önico)</label>
                <input type="text" id="idJogo" placeholder="ex: neonrunner">
                
                <div style="display:flex; gap:10px;">
                    <div style="flex:2;"><label>Nome Vis√≠vel</label><input type="text" id="nome" placeholder="ex: Neon Runner 3D"></div>
                    <div style="flex:1;"><label>Vers√£o</label><input type="text" id="versao" placeholder="v1.0"></div>
                </div>

                <label>Descri√ß√£o</label>
                <input type="text" id="desc" placeholder="ex: Desvie dos obst√°culos...">
                
                <label>Categorias / Tags (Separe por v√≠rgula)</label>
                <input type="text" id="tagJogo" placeholder="ex: A√ß√£o, Corrida, 3D">
                
                <label>Data de Inclus√£o (Para ordenar em Novidades)</label>
                <input type="datetime-local" id="dataInclusao">
                
                <div style="margin-top:15px; display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="ocultarNovidade" style="width:20px; height:20px;">
                    <span><strong>Ocultar das Novidades?</strong> (Jogo antigo ou manuten√ß√£o)</span>
                </div>

                <div style="display:flex; gap:10px;">
                    <div style="flex:1;"><label>Arquivo (Link)</label><input type="text" id="arquivo" placeholder="ex: jogos/pasta/index.html"></div>
                    <div style="flex:1;"><label>Imagem (Link)</label><input type="text" id="img" placeholder="ex: capas/neon.jpg"></div>
                </div>
                <div class="btn-row">
                    <button class="btn-clear" onclick="limparFormulario()">üßπ Limpar</button>
                    <button class="btn-save" onclick="salvarJogo()">üíæ SALVAR JOGO</button>
                </div>
            </div>
            <div class="list-container">
                <h3>üìÇ Jogos Cadastrados</h3>
                <div id="lista-jogos">Carregando...</div>
            </div>
        </div>

        <!-- CONTE√öDO: NOT√çCIAS -->
        <div id="tab-noticias" class="tab-content">
            <div class="editor-card" style="border-left-color: #4CAF50;">
                <h3>Nova Not√≠cia / Aviso</h3>
                <input type="hidden" id="idNoticia">
                <label>T√≠tulo</label>
                <input type="text" id="tituloNoticia" placeholder="ex: Manuten√ß√£o Programada">
                <label>Texto da Not√≠cia</label>
                <textarea id="textoNoticia" rows="4" placeholder="Escreva aqui as novidades..."></textarea>
                <label>Imagem (Opcional)</label>
                <input type="text" id="imgNoticia" placeholder="ex: banners/aviso.jpg">
                
                <div class="btn-row">
                    <button class="btn-clear" onclick="limparNoticia()">üßπ Limpar</button>
                    <button class="btn-delete" onclick="deletarNoticia()">üóëÔ∏è</button>
                    <button class="btn-save" style="background: #4CAF50;" onclick="salvarNoticia()">üì¢ PUBLICAR</button>
                </div>
            </div>
            <div class="list-container">
                <h3>üì∞ Feed de Not√≠cias</h3>
                <div id="lista-noticias">Carregando...</div>
            </div>
        </div>

        <!-- CONTE√öDO: BANNERS -->
        <div id="tab-banners" class="tab-content">
            <div class="editor-card" style="border-left-color: #9C27B0;">
                <h3>Novo/Editar Banner</h3>
                <label>ID do Banner</label>
                <input type="text" id="idBanner" placeholder="ex: banner_natal">
                <div style="display:flex; gap:10px;">
                    <div style="flex:2;"><label>Arquivo Imagem</label><input type="text" id="arquivoBanner" placeholder="ex: promo1.jpg"></div>
                    <div style="flex:1;"><label>Ordem</label><input type="number" id="ordemBanner" placeholder="1"></div>
                </div>
                <label>Link Destino</label>
                <input type="text" id="linkBanner" placeholder="ex: #tab-rank">
                <div class="btn-row">
                    <button class="btn-clear" onclick="limparFormularioBanner()">üßπ Limpar</button>
                    <button class="btn-delete" onclick="deletarBanner()">üóëÔ∏è Deletar</button>
                    <button class="btn-save" style="background: #9C27B0;" onclick="salvarBanner()">üíæ SALVAR</button>
                </div>
            </div>
            <div class="list-container">
                <h3>üñºÔ∏è Banners Ativos</h3>
                <div id="lista-banners">Carregando...</div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIR7CqYYvMZVQxtO67JCQoJ3OLT1cvAx8",
            authDomain: "kn-jogos.firebaseapp.com",
            projectId: "kn-jogos",
            storageBucket: "kn-jogos.firebasestorage.app",
            messagingSenderId: "273132829744",
            appId: "1:273132829744:web:a03e85b80ffabfa24101f5",
            measurementId: "G-CX4Z8R1S6F"
        };

        const app = initializeApp(firebaseConfig);
        try { const appCheck = initializeAppCheck(app, { provider: new ReCaptchaV3Provider('6Lc5vjgsAAAAANx2ia8s_Fh0_KS0_YNaAlSIYpJC'), isTokenAutoRefreshEnabled: true }); } catch (e) {}

        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const ADMIN_EMAIL = "adenilsonantonioromao@gmail.com";

        document.getElementById('btn-login').addEventListener('click', () => { signInWithPopup(auth, provider).catch(alert); });
        
        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ADMIN_EMAIL) {
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                carregarListaJogos();
                carregarListaBanners();
                carregarListaNoticias();
            } else if (user) {
                document.getElementById('error-msg').style.display = 'block';
                document.getElementById('error-msg').innerText = "Acesso Negado.";
                signOut(auth);
            }
        });
        
        window.sair = () => signOut(auth).then(() => location.reload());

        window.mudarAba = function(aba) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + aba).classList.add('active');
            
            const btns = document.querySelectorAll('.tab-btn');
            if(aba === 'jogos') btns[0].classList.add('active');
            else if(aba === 'noticias') btns[1].classList.add('active');
            else btns[2].classList.add('active');
        }

        // --- JOGOS ---
        window.carregarListaJogos = async function() {
            const divLista = document.getElementById('lista-jogos');
            divLista.innerHTML = "Lendo...";
            try {
                const querySnapshot = await getDocs(collection(db, "listaJogos"));
                divLista.innerHTML = "";
                let jogos = [];
                querySnapshot.forEach(doc => jogos.push(doc.data()));
                jogos.sort((a, b) => new Date(b.dataInclusao) - new Date(a.dataInclusao));

                jogos.forEach((data) => {
                    const item = document.createElement('div');
                    item.className = 'item-list';
                    const dataInc = data.dataInclusao ? new Date(data.dataInclusao).toLocaleDateString('pt-BR') : 'Sem data';
                    
                    let tagsHtml = "";
                    if (data.tags && Array.isArray(data.tags)) tagsHtml = data.tags.map(t => `<span class="tag-badge">${t}</span>`).join(' ');
                    else if (data.tag) tagsHtml = `<span class="tag-badge">${data.tag}</span>`;
                    
                    const versaoHtml = data.versao ? `<span class="versao-badge">${data.versao}</span>` : "";
                    const hiddenIcon = data.ocultarNaHome ? "üëÅÔ∏è‚Äçüó®Ô∏è (Oculto)" : "";

                    item.innerHTML = `<div><span style="font-family:monospace; background:#eee; padding:2px;">${data.id}</span> <strong>${data.nome}</strong> ${versaoHtml} ${hiddenIcon} ${tagsHtml}<br><span class="date-badge">${dataInc}</span></div><span>‚úèÔ∏è</span>`;
                    item.onclick = () => preencherEditorJogo(data);
                    divLista.appendChild(item);
                });
            } catch (e) { console.error(e); }
        }

        function preencherEditorJogo(data) {
            document.getElementById('idJogo').value = data.id;
            document.getElementById('nome').value = data.nome;
            document.getElementById('versao').value = data.versao || "";
            document.getElementById('desc').value = data.desc;
            let tagsTexto = (data.tags && Array.isArray(data.tags)) ? data.tags.join(', ') : (data.tag || "");
            document.getElementById('tagJogo').value = tagsTexto;
            
            // Converte data ISO para formato do input datetime-local (YYYY-MM-DDTHH:MM)
            if(data.dataInclusao) {
                try {
                    const dateObj = new Date(data.dataInclusao);
                    // Ajuste fuso hor√°rio simples para exibir no input
                    dateObj.setMinutes(dateObj.getMinutes() - dateObj.getTimezoneOffset());
                    document.getElementById('dataInclusao').value = dateObj.toISOString().slice(0,16);
                } catch(e) { document.getElementById('dataInclusao').value = ""; }
            } else {
                document.getElementById('dataInclusao').value = "";
            }

            document.getElementById('arquivo').value = data.arquivo;
            document.getElementById('img').value = data.img;
            document.getElementById('ocultarNovidade').checked = data.ocultarNaHome || false;
            mostrarStatus(`Editando: ${data.nome}`);
        }

        window.salvarJogo = async function() {
            const id = document.getElementById('idJogo').value.toLowerCase().trim();
            const nome = document.getElementById('nome').value;
            const versao = document.getElementById('versao').value;
            const desc = document.getElementById('desc').value;
            const tagInput = document.getElementById('tagJogo').value;
            const tagsArray = tagInput.split(',').map(t => t.trim()).filter(t => t.length > 0);
            const arquivo = document.getElementById('arquivo').value;
            const img = document.getElementById('img').value;
            const ocultar = document.getElementById('ocultarNovidade').checked;
            
            // Data de Inclus√£o Manual ou Autom√°tica
            let dataInclusao = document.getElementById('dataInclusao').value;
            if (dataInclusao) {
                dataInclusao = new Date(dataInclusao).toISOString();
            } else {
                // Se n√£o preencheu, usa a data atual (apenas se for novo jogo, idealmente, mas aqui atualiza se vazio)
                dataInclusao = new Date().toISOString();
            }
            
            if(!id) return alert("ID obrigat√≥rio");
            
            try {
                const docRef = doc(db, "listaJogos", id);
                const docSnap = await getDoc(docRef);
                const agora = new Date().toISOString();
                
                let dados = { 
                    id, nome, versao, desc, 
                    tags: tagsArray, tag: tagsArray[0] || "",
                    arquivo, img, ocultarNaHome: ocultar,
                    dataInclusao: dataInclusao, // Salva a data escolhida
                    dataAtualizacao: agora 
                };
                
                // Se o jogo j√° existe e o campo data estava vazio no form, tenta manter a data original se n√£o quiser mudar
                // Mas como queremos poder alterar, o valor do input manda.
                
                await setDoc(docRef, dados, { merge: true });
                await setDoc(doc(db, "config", "gameStats"), { [id]: 0 }, { merge: true });
                
                mostrarStatus("‚úÖ Jogo Salvo!");
                carregarListaJogos();
            } catch(e) { alert("Erro ao salvar: " + e.message); }
        }

        // --- NOT√çCIAS ---
        window.carregarListaNoticias = async function() {
            const div = document.getElementById('lista-noticias');
            div.innerHTML = "Lendo...";
            try {
                const snapshot = await getDocs(collection(db, "listaNoticias"));
                div.innerHTML = "";
                let lista = [];
                snapshot.forEach(d => lista.push({...d.data(), uid: d.id}));
                lista.sort((a,b) => new Date(b.data) - new Date(a.data));

                lista.forEach(n => {
                    const item = document.createElement('div');
                    item.className = 'item-list';
                    const dataF = new Date(n.data).toLocaleDateString('pt-BR');
                    item.innerHTML = `<div><strong>${n.titulo}</strong><br><span class="date-badge">${dataF}</span></div><span>‚úèÔ∏è</span>`;
                    item.onclick = () => {
                        document.getElementById('idNoticia').value = n.uid;
                        document.getElementById('tituloNoticia').value = n.titulo;
                        document.getElementById('textoNoticia').value = n.texto;
                        document.getElementById('imgNoticia').value = n.imagem || "";
                        mostrarStatus("Editando Not√≠cia");
                    };
                    div.appendChild(item);
                });
            } catch(e) { console.error(e); }
        }

        window.salvarNoticia = async function() {
            const uid = document.getElementById('idNoticia').value || "news_" + Date.now();
            const titulo = document.getElementById('tituloNoticia').value;
            const texto = document.getElementById('textoNoticia').value;
            const imagem = document.getElementById('imgNoticia').value;
            
            if(!titulo) return alert("T√≠tulo obrigat√≥rio");

            try {
                await setDoc(doc(db, "listaNoticias", uid), {
                    titulo, texto, imagem,
                    data: new Date().toISOString(),
                    tipo: 'news' 
                });
                mostrarStatus("‚úÖ Not√≠cia Publicada!");
                window.limparNoticia();
                window.carregarListaNoticias();
            } catch(e) {
                console.error(e);
                alert("Erro ao publicar: " + e.message);
            }
        }

        window.deletarNoticia = async function() {
            const uid = document.getElementById('idNoticia').value;
            if(!uid) return;
            if(confirm("Apagar not√≠cia?")) {
                try {
                    await deleteDoc(doc(db, "listaNoticias", uid));
                    window.limparNoticia();
                    window.carregarListaNoticias();
                    mostrarStatus("üóëÔ∏è Not√≠cia Apagada.");
                } catch(e) { alert("Erro ao apagar: " + e.message); }
            }
        }
        
        window.limparNoticia = function() {
            document.getElementById('idNoticia').value = "";
            document.getElementById('tituloNoticia').value = "";
            document.getElementById('textoNoticia').value = "";
            document.getElementById('imgNoticia').value = "";
        }

        // --- BANNERS ---
        window.carregarListaBanners = async function() {
            const divLista = document.getElementById('lista-banners');
            divLista.innerHTML = "Lendo...";
            try {
                const querySnapshot = await getDocs(collection(db, "listaBanners"));
                divLista.innerHTML = "";
                let banners = [];
                querySnapshot.forEach((doc) => banners.push(doc.data()));
                banners.sort((a, b) => a.ordem - b.ordem);
                banners.forEach((data) => {
                    const item = document.createElement('div');
                    item.className = 'item-list';
                    item.innerHTML = `<div style="display:flex; align-items:center;"><span style="font-weight:bold; font-size:1.2rem; margin-right:15px; color:#9C27B0;">#${data.ordem}</span><div><strong>${data.arquivo}</strong></div></div><span>‚úèÔ∏è</span>`;
                    item.onclick = () => preencherEditorBanner(data);
                    divLista.appendChild(item);
                });
            } catch (e) { console.error(e); }
        }
        function preencherEditorBanner(data) {
            document.getElementById('idBanner').value = data.id;
            document.getElementById('arquivoBanner').value = data.arquivo;
            document.getElementById('ordemBanner').value = data.ordem;
            document.getElementById('linkBanner').value = data.link || "";
            mostrarStatus(`Editando Banner: ${data.id}`);
        }
        window.salvarBanner = async function() {
            let id = document.getElementById('idBanner').value.trim();
            const arquivo = document.getElementById('arquivoBanner').value;
            const ordem = parseInt(document.getElementById('ordemBanner').value) || 99;
            const link = document.getElementById('linkBanner').value.trim();
            if(!arquivo) return alert("Arquivo obrigat√≥rio");
            if(!id) id = "banner_" + Date.now();
            try {
                await setDoc(doc(db, "listaBanners", id), { id, arquivo, ordem, link }, { merge: true });
                mostrarStatus("‚úÖ Banner Salvo!");
                carregarListaBanners();
                limparFormularioBanner();
            } catch(e) { alert("Erro ao salvar banner."); }
        }
        window.deletarBanner = async function() {
            const id = document.getElementById('idBanner').value.trim();
            if(!id) return;
            if(confirm("Apagar banner?")) { try { await deleteDoc(doc(db, "listaBanners", id)); mostrarStatus("üóëÔ∏è Banner Removido."); carregarListaBanners(); limparFormularioBanner(); } catch(e) {} }
        }

        function mostrarStatus(msg) {
            const s = document.getElementById('status');
            s.style.display = 'block'; s.innerText = msg; s.style.background = '#d4edda';
            setTimeout(() => s.style.display = 'none', 3000);
        }
        window.limparFormulario = () => { 
            document.querySelectorAll('#tab-jogos input').forEach(i => i.value = ''); 
            document.getElementById('ocultarNovidade').checked = false; 
        }
        window.limparFormularioBanner = () => { document.querySelectorAll('#tab-banners input').forEach(i => i.value = ''); }

    </script>
</body>
</html>
