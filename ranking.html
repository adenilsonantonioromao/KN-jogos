<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking Global - KN Jogos</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&display=swap');
        
        body { 
            font-family: 'Nunito', sans-serif; 
            background-color: #f0fdf4; 
            margin: 0; 
            padding: 20px; 
            text-align: center; 
            color: #37474F; 
            padding-top: 80px; 
        }

        h1 { font-family: 'Fredoka One', cursive; color: #FF5722; margin-bottom: 5px; font-size: 2rem; }
        p.subtitle { color: #666; margin-bottom: 20px; font-size: 0.9rem; }

        /* BOT√ÉO VOLTAR */
        .btn-back-home {
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
            background: #4CAF50; color: white; text-decoration: none;
            padding: 12px 30px; border-radius: 50px; font-weight: bold;
            font-family: 'Fredoka One', cursive;
            box-shadow: 0 4px 0 #2E7D32, 0 10px 20px rgba(0,0,0,0.2);
            z-index: 1000; display: flex; align-items: center; gap: 10px;
            transition: transform 0.1s; width: 80%; max-width: 300px;
            justify-content: center; border: 2px solid #fff;
        }
        .btn-back-home:active { transform: translateX(-50%) translateY(4px); box-shadow: 0 0 0 #2E7D32; }
        .btn-back-home span { font-size: 1.2rem; }

        /* ABAS */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; margin-top: 10px; }
        .tab-btn { padding: 10px 20px; background: #ddd; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; transition: 0.3s; flex: 1; max-width: 150px; font-size: 0.9rem; }
        .tab-btn.active { background: #FF5722; color: white; transform: scale(1.05); box-shadow: 0 4px 10px rgba(255,87,34,0.3); }
        .content-section { display: none; animation: fadeIn 0.5s; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- NOVO: CAIXAS DE REGRAS --- */
        .rules-box {
            background: #fff8e1; /* Amarelo suave */
            border: 2px solid #ffe082;
            border-radius: 15px;
            padding: 15px;
            text-align: left;
            max-width: 600px;
            margin: 0 auto 20px auto;
            font-size: 0.85rem;
            color: #5d4037;
            box-shadow: 0 4px 0 rgba(0,0,0,0.05);
        }
        .rules-title { font-weight: bold; color: #ff6f00; display: flex; align-items: center; gap: 5px; margin-bottom: 8px; font-size: 1rem; }
        .rules-list { margin: 0; padding-left: 20px; list-style-type: disc; }
        .rules-list li { margin-bottom: 4px; }
        
        /* TABELA */
        .ranking-table { width: 100%; max-width: 800px; margin: 0 auto; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
        th { background: #37474F; color: white; cursor: pointer; user-select: none; font-size: 0.9rem; }
        th:hover { background: #455A64; }
        tr:nth-child(even) { background: #fafafa; }
        tr:hover { background: #e0f7fa; }
        .user-cell { display: flex; align-items: center; gap: 10px; justify-content: flex-start; text-align: left; }
        .user-cell img { width: 35px; height: 35px; border-radius: 50%; border: 2px solid #FFC107; object-fit: cover; }
        .score-val { font-weight: bold; color: #4CAF50; }

        /* PODIUM */
        .podium-container { display: flex; justify-content: center; align-items: flex-end; height: 320px; margin-bottom: 30px; gap: 10px; padding-top: 20px; }
        .podium-place { width: 100px; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; position: relative; }
        .podium-avatar { width: 60px; height: 60px; border-radius: 50%; border: 3px solid white; margin-bottom: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); object-fit: cover; }
        .podium-name { font-weight: bold; margin-bottom: 8px; font-size: 0.85rem; color: #37474F; background: rgba(255,255,255,0.8); padding: 2px 8px; border-radius: 10px; white-space: nowrap; max-width: 100%; overflow: hidden; text-overflow: ellipsis; }
        .podium-points { background: #333; color: #FFC107; padding: 4px 10px; border-radius: 15px; font-size: 0.75rem; font-weight: bold; z-index: 2; margin-bottom: -12px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); position: relative; }
        .podium-bar { width: 100%; border-radius: 10px 10px 0 0; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 10px; font-weight: bold; color: rgba(0,0,0,0.5); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .place-1 .podium-bar { height: 160px; background: linear-gradient(to top, #FFD700, #FFF176); font-size: 2rem; }
        .place-2 .podium-bar { height: 110px; background: linear-gradient(to top, #C0C0C0, #E0E0E0); font-size: 1.5rem; }
        .place-3 .podium-bar { height: 80px; background: linear-gradient(to top, #CD7F32, #E6A67C); font-size: 1.2rem; }
        .place-1 .podium-avatar { width: 80px; height: 80px; border: 4px solid #FFD700; }
        .place-1 .podium-name { font-size: 1rem; color: #E65100; }

        .champ-list { max-width: 600px; margin: 0 auto; list-style: none; padding: 0; }
        .champ-item { background: white; padding: 10px; margin-bottom: 5px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.1s; }
        .champ-item:active { transform: scale(0.98); }
        #error-msg { color: red; margin: 20px; font-weight: bold; display: none; }
    </style>
</head>
<body>

    <a href="index.html" class="btn-back-home"><span>üéÆ</span> VOLTAR AO JOGO</a>

    <h1>üìä Central de Rankings</h1>
    
    <div class="tabs">
        <button class="tab-btn active" onclick="mudarAba('tabelao')">üìà Tabel√£o Geral</button>
        <button class="tab-btn" onclick="mudarAba('campeoes')">üëë Galeria dos Campe√µes</button>
    </div>

    <!-- MENSAGEM DE ERRO -->
    <div id="error-msg"></div>

    <!-- ABA 1: TABEL√ÉO -->
    <div id="tabelao" class="content-section active">
        <!-- CAIXA DE REGRAS DO TABEL√ÉO -->
        <div class="rules-box">
            <div class="rules-title">‚ÑπÔ∏è Como Funciona a Temporada</div>
            <ul class="rules-list">
                <li><strong>Di√°rio:</strong> Reseta toda noite (00:00). Top 5 ganham pr√™mios.</li>
                <li><strong>Semanal:</strong> Acumule pontos at√© Sexta-feira. Pr√™mios maiores!</li>
                <li><strong>Mensal:</strong> O Grande Campe√£o! Reseta todo dia 01 do m√™s.</li>
                <li><strong>Pr√™mios:</strong> Os melhores ganham Fichas ü™ô e Pontos de Campe√£o ‚≠ê.</li>
            </ul>
        </div>

        <p style="font-size:0.8rem; color:#666;">Clique nos t√≠tulos das colunas para ordenar!</p>
        <div style="overflow-x:auto;">
            <table class="ranking-table">
                <thead>
                    <tr>
                        <th style="text-align:left; padding-left:20px;">Jogador</th>
                        <th onclick="ordenarPor('diario')">Di√°rio ‚ñº</th>
                        <th onclick="ordenarPor('semanal')">Semanal ‚ñº</th>
                        <th onclick="ordenarPor('mensal')">Mensal ‚ñº</th>
                    </tr>
                </thead>
                <tbody id="tabela-corpo">
                    <tr><td colspan="4">Carregando dados...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ABA 2: CAMPE√ïES -->
    <div id="campeoes" class="content-section">
        <p class="subtitle" style="font-weight:bold; color:#E65100;">Confira sua pontua√ß√£o dos campe√µes ‚≠ê</p>
        
        <!-- CAIXA DE REGRAS DOS CAMPE√ïES -->
        <div class="rules-box" style="background:#FFF3E0; border-color:#FFB74D; color:#E65100;">
            <div class="rules-title">üëë O Hall da Fama</div>
            <p style="margin:0;">Estes pontos representam sua gl√≥ria eterna! Eles <strong>NUNCA resetam</strong>. S√£o conquistados ao ficar no Top 5 dos rankings Di√°rio, Semanal ou Mensal.</p>
        </div>

        <div id="podium" class="podium-container"></div>
        
        <h3 style="color:#555; font-size:1.2rem; margin-top:30px;">üèÖ Placar Geral dos Campe√µes</h3>
        <ul id="lista-campeoes" class="champ-list"></ul>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIR7CqYYvMZVQxtO67JCQoJ3OLT1cvAx8",
            authDomain: "kn-jogos.firebaseapp.com",
            projectId: "kn-jogos",
            storageBucket: "kn-jogos.firebasestorage.app",
            messagingSenderId: "273132829744",
            appId: "1:273132829744:web:a03e85b80ffabfa24101f5",
            measurementId: "G-CX4Z8R1S6F"
        };

        const app = initializeApp(firebaseConfig);
        try {
            initializeAppCheck(app, {
                provider: new ReCaptchaV3Provider('6Lc5vjgsAAAAANx2ia8s_Fh0_KS0_YNaAlSIYpJC'),
                isTokenAutoRefreshEnabled: true
            });
        } catch(e) { console.warn("AppCheck:", e); }

        const db = getFirestore(app);
        let todosUsuarios = [];

        function getDayKey() { return new Date().toLocaleDateString('pt-BR'); }
        function getMonthKey() { const d = new Date(); return `${d.getMonth()+1}/${d.getFullYear()}`; }
        function getWeekKey() {
            const d = new Date(); d.setHours(0, 0, 0, 0); d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
            const week1 = new Date(d.getFullYear(), 0, 4);
            return 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        async function carregarDados() {
            try {
                const snap = await getDocs(collection(db, "users"));
                todosUsuarios = [];
                
                const hoje = getDayKey();
                const semana = getWeekKey();
                const mes = getMonthKey();

                snap.forEach(doc => {
                    const d = doc.data();
                    todosUsuarios.push({
                        nome: d.apelido || d.nome.split(' ')[0],
                        foto: d.foto,
                        diario: (d.dataUltimoDiario === hoje) ? (d.scoreDiario || 0) : 0,
                        semanal: (d.dataUltimoSemanal === semana) ? (d.scoreSemanal || 0) : 0,
                        mensal: (d.dataUltimoMensal === mes) ? (d.scoreMensal || 0) : 0,
                        campeao: d.pontosCampeao || 0
                    });
                });

                renderizarTabela('mensal');
                renderizarCampeoes();
            } catch (error) {
                console.error(error);
                document.getElementById('tabela-corpo').innerHTML = `<tr><td colspan="4">Erro. Recarregue.</td></tr>`;
            }
        }

        window.ordenarPor = function(criterio) { renderizarTabela(criterio); }

        function renderizarTabela(criterio) {
            todosUsuarios.sort((a, b) => b[criterio] - a[criterio]);
            const tbody = document.getElementById('tabela-corpo');
            tbody.innerHTML = "";

            if(todosUsuarios.length === 0) { tbody.innerHTML = "<tr><td colspan='4'>Nenhum dado.</td></tr>"; return; }

            todosUsuarios.forEach(u => {
                const styleD = criterio === 'diario' ? 'background:#e8f5e9;' : '';
                const styleS = criterio === 'semanal' ? 'background:#e8f5e9;' : '';
                const styleM = criterio === 'mensal' ? 'background:#e8f5e9;' : '';
                tbody.innerHTML += `
                    <tr>
                        <td><div class="user-cell"><img src="${u.foto}"> ${u.nome}</div></td>
                        <td style="${styleD}" class="score-val">${u.diario}</td>
                        <td style="${styleS}" class="score-val">${u.semanal}</td>
                        <td style="${styleM}" class="score-val">${u.mensal}</td>
                    </tr>`;
            });
        }

        function renderizarCampeoes() {
            const campeoes = [...todosUsuarios].sort((a, b) => b.campeao - a.campeao);
            const top3 = campeoes.slice(0, 3);
            const resto = campeoes.slice(3);

            const podium = document.getElementById('podium');
            podium.innerHTML = "";

            const ordemPodio = [1, 0, 2];
            ordemPodio.forEach(i => {
                if(top3[i]) {
                    const u = top3[i];
                    const pos = i + 1;
                    podium.innerHTML += `
                        <div class="podium-place place-${pos}">
                            <img src="${u.foto}" class="podium-avatar">
                            <div class="podium-name">${u.nome}</div>
                            <div class="podium-points">‚≠ê ${u.campeao}</div>
                            <div class="podium-bar">#${pos}</div>
                        </div>`;
                }
            });

            const lista = document.getElementById('lista-campeoes');
            lista.innerHTML = "";
            
            // Aqui garantimos que todos do 4¬∫ para baixo aparecem
            resto.forEach((u, index) => {
                // S√≥ mostra se tiver pelo menos 1 ponto de campe√£o, sen√£o a lista fica gigante com zeros
                if(u.campeao >= 0) { 
                    lista.innerHTML += `
                        <li class="champ-item">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <span style="font-weight:bold; color:#999;">#${index + 4}</span>
                                <img src="${u.foto}" style="width:30px; height:30px; border-radius:50%;">
                                ${u.nome}
                            </div>
                            <div style="font-weight:bold; color:#FFC107;">‚≠ê ${u.campeao}</div>
                        </li>`;
                }
            });
            
            if(lista.innerHTML === "" && podium.innerHTML === "") {
                document.getElementById('campeoes').innerHTML += "<p style='margin-top:50px;'>Ainda n√£o temos campe√µes coroados! üëë</p>";
            }
        }

        window.mudarAba = function(aba) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(aba).classList.add('active');
            const btns = document.querySelectorAll('.tab-btn');
            if(aba === 'tabelao') btns[0].classList.add('active'); else btns[1].classList.add('active');
        }

        carregarDados();
    </script>
</body>
</html>
