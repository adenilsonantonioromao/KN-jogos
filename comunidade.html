<!-- ... (HTML e CSS MANTIDOS IGUAIS) ... -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBIR7CqYYvMZVQxtO67JCQoJ3OLT1cvAx8", authDomain: "kn-jogos.firebaseapp.com", projectId: "kn-jogos", storageBucket: "kn-jogos.firebasestorage.app", messagingSenderId: "273132829744", appId: "1:273132829744:web:a03e85b80ffabfa24101f5" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let AVATAR_CONFIG = { scale: 0.22, parts: { 'capa': { x: 0, y: 0, pivX: 0.5, pivY: 0.5 }, 'perna_tras': { x: -24, y: 50, pivX: 0.67, pivY: 0.11 }, 'perna_frente': { x: 24, y: 50, pivX: 0.29, pivY: 0.13 }, 'braco_tras': { x: -37, y: -150, pivX: 0.76, pivY: 0.11 }, 'tronco': { x: 0, y: 0, pivX: 0.47, pivY: 0.75 }, 'cabeca': { x: 0, y: -230, pivX: 0.50, pivY: 0.89 }, 'braco_frente': { x: 47, y: -150, pivX: 0.26, pivY: 0.12 } } };
        const LAYER_ORDER = ['capa', 'escudo_tras', 'braco_tras', 'perna_tras', 'perna_frente', 'tronco', 'cintura', 'cabeca', 'rosto', 'mascara', 'cabelo', 'arma_frente', 'braco_frente', 'escudo_frente'];
        const avatarImages = {};
        const BASE_URL = 'assets/avatar/base/'; 

        async function start() {
            try { const snap = await getDoc(doc(db, "config", "avatar_base")); if(snap.exists()) { const data = snap.data(); AVATAR_CONFIG.scale = data.scale; AVATAR_CONFIG.parts = { ...AVATAR_CONFIG.parts, ...data.parts }; console.log("Config baixada."); } } catch(e) {}
            carregarAssets();
        }

        let assetsLoaded = 0;
        function carregarAssets() {
            LAYER_ORDER.forEach(name => { const img = new Image(); img.src = `${BASE_URL}${name}.png`; img.onload = () => { assetsLoaded++; if(assetsLoaded >= 5) initArcade(); }; img.onerror = () => { img.isBroken = true; assetsLoaded++; if(assetsLoaded >= 5) initArcade(); }; avatarImages[name] = img; });
            setTimeout(() => { if(!initCalled) initArcade(); }, 2000);
        }

        class Avatar {
            constructor(nome, isMe = false) {
                this.nome = nome; this.isMe = isMe; this.msg = ""; this.msgTimer = 0; this.x = 0; this.y = 0; this.dir = Math.random() > 0.5 ? 1 : -1; this.speed = Math.random() * 0.8 + 0.5; this.state = 'walk'; this.timer = Math.random() * 100; this.targetX = this.x; setTimeout(() => this.escolherNovoAlvo(), 500);
            }
            falar(texto) { this.msg = texto; this.msgTimer = 300; this.timer = 0; }
            escolherNovoAlvo() { const canvasEl = document.getElementById('arcadeCanvas'); if(!canvasEl) return; const width = canvasEl.clientWidth; const margem = 50; this.targetX = Math.random() * (width - margem*2) + margem; this.dir = this.targetX > this.x ? 1 : -1; this.state = 'walk'; setTimeout(() => { this.state = 'idle'; setTimeout(() => this.escolherNovoAlvo(), Math.random() * 2000 + 1000); }, Math.random() * 4000 + 2000); }
            update(dt) { this.timer += dt * 5; if(this.msgTimer > 0) this.msgTimer--; else this.msg = ""; if (this.state === 'walk') { this.x += this.dir * this.speed; if (Math.abs(this.x - this.targetX) < 10) this.state = 'idle'; } }
            draw(ctx) {
                const s = AVATAR_CONFIG.scale;
                let walk = 0, bob = 0, breathe = Math.sin(this.timer * 0.5) * 0.05;
                if (this.state === 'walk') { walk = Math.sin(this.timer); bob = Math.abs(Math.sin(this.timer)) * 10; }

                ctx.save(); ctx.translate(this.x, this.y);
                ctx.fillStyle = this.isMe ? '#FFC107' : 'white'; ctx.font = 'bold 12px Nunito'; ctx.textAlign = 'center'; ctx.shadowColor = 'rgba(0,0,0,0.8)'; ctx.shadowBlur = 3; ctx.fillText(this.nome, 0, -160 * s); ctx.shadowBlur = 0;
                if (this.msg) this.drawBalloon(ctx, s);
                ctx.scale(-this.dir, 1); 

                LAYER_ORDER.forEach(partName => {
                    let animX = 0, animY = 0, animRot = 0;
                    
                    // LÓGICA DE PARENTING (ANEXAR)
                    if (partName === 'arma_frente' || partName === 'escudo_frente') {
                        const parent = AVATAR_CONFIG.parts['braco_frente'] || {x:0, y:0};
                        const cfg = AVATAR_CONFIG.parts[partName] || {x:0, y:0, pivX:0.5, pivY:0.5};
                        const pRot = (this.state === 'walk') ? -walk * 0.6 : 0;
                        
                        const relX = (cfg.x - parent.x) * s;
                        const relY = (cfg.y - parent.y) * s;
                        const rotX = relX * Math.cos(pRot) - relY * Math.sin(pRot);
                        const rotY = relX * Math.sin(pRot) + relY * Math.cos(pRot);
                        
                        this.drawPartRaw(ctx, partName, ((parent.x * s) + rotX), ((parent.y * s) - (bob*s) + rotY), pRot);
                        return;
                    }
                    if (partName === 'escudo_tras') {
                        const parent = AVATAR_CONFIG.parts['braco_tras'] || {x:0, y:0};
                        const cfg = AVATAR_CONFIG.parts[partName] || {x:0, y:0, pivX:0.5, pivY:0.5};
                        const pRot = (this.state === 'walk') ? walk * 0.6 : 0;
                        const relX = (cfg.x - parent.x) * s; const relY = (cfg.y - parent.y) * s;
                        const rotX = relX * Math.cos(pRot) - relY * Math.sin(pRot); const rotY = relX * Math.sin(pRot) + relY * Math.cos(pRot);
                        this.drawPartRaw(ctx, partName, ((parent.x * s) + rotX), ((parent.y * s) - (bob*s) + rotY), pRot);
                        return;
                    }

                    if (partName.includes('perna')) { const isFrente = partName.includes('frente'); animY = -bob; animRot = (isFrente ? walk : -walk) * 0.5; } 
                    else if (partName.includes('braco')) { const isFrente = partName.includes('frente'); animY = -bob; animRot = (isFrente ? -walk : walk) * 0.6; }
                    else if (['cabeca', 'rosto', 'mascara', 'cabelo'].includes(partName)) { animY = -bob + (breathe * 5); animRot = breathe * 0.2; }
                    else { animY = -bob; }

                    this.drawPart(ctx, partName, animX * s, animY * s, animRot);
                });
                ctx.restore();
            }

            drawPart(ctx, name, x, y, rot) {
                const cfg = AVATAR_CONFIG.parts[name] || { x:0, y:0, pivX:0.5, pivY:0.5 };
                const s = AVATAR_CONFIG.scale;
                this.drawPartRaw(ctx, name, (cfg.x * s) + x, (cfg.y * s) + y, rot);
            }

            drawPartRaw(ctx, name, finalX, finalY, rot) {
                const img = avatarImages[name];
                if (!img || !img.complete || img.isBroken || img.naturalWidth === 0) return;
                const cfg = AVATAR_CONFIG.parts[name] || { x:0, y:0, pivX:0.5, pivY:0.5 };
                const s = AVATAR_CONFIG.scale;
                ctx.save();
                ctx.translate(finalX, finalY);
                ctx.rotate(rot);
                if (name.includes('tras') || name === 'capa') ctx.filter = "brightness(0.85)";
                ctx.drawImage(img, -img.width * s * cfg.pivX, -img.height * s * cfg.pivY, img.width * s, img.height * s);
                ctx.filter = "none";
                ctx.restore();
            }

            drawBalloon(ctx, s) {
                ctx.save(); ctx.translate(0, -190 * s); ctx.fillStyle = 'white'; ctx.shadowColor = 'rgba(0,0,0,0.2)'; ctx.shadowBlur = 5; ctx.shadowOffsetY = 3;
                const w = ctx.measureText(this.msg).width + 30;
                ctx.beginPath(); ctx.roundRect(-w/2, -30, w, 30, 10); ctx.fill();
                ctx.beginPath(); ctx.moveTo(-5, 0); ctx.lineTo(5, 0); ctx.lineTo(0, 10); ctx.fill();
                ctx.fillStyle = '#333'; ctx.shadowColor = 'transparent'; ctx.fillText(this.msg, 0, -10); ctx.restore();
            }
        }

        const canvas = document.getElementById('arcadeCanvas'); const container = document.getElementById('canvasContainer'); const ctx = canvas.getContext('2d');
        let avatares = []; let lastTime = 0; let myAvatar = null; let initCalled = false;

        function initArcade() { if(initCalled) return; initCalled = true; myAvatar = new Avatar("Eu", true); avatares.push(myAvatar); window.addEventListener('resize', resize); resize(); requestAnimationFrame(loop); }
        function resize() { const dpr = window.devicePixelRatio || 1; const rect = container.getBoundingClientRect(); if(rect.width === 0 || rect.height === 0) return; canvas.width = rect.width * dpr; canvas.height = rect.height * dpr; ctx.setTransform(1, 0, 0, 1, 0, 0); ctx.scale(dpr, dpr); const chaoY = rect.height - 90; avatares.forEach(a => { a.y = chaoY; if(a.x === 0) a.x = rect.width / 2; }); }
        function loop(timestamp) { if (!lastTime) lastTime = timestamp; const dt = (timestamp - lastTime) / 1000; lastTime = timestamp; const w = canvas.clientWidth; const h = canvas.clientHeight; ctx.clearRect(0, 0, w, h); ctx.fillStyle = '#81C784'; ctx.beginPath(); ctx.ellipse(w/2, h + 80, w * 0.9, 150, 0, 0, Math.PI * 2); ctx.fill(); ctx.strokeStyle = '#4CAF50'; ctx.lineWidth = 10; ctx.stroke(); avatares.sort((a, b) => a.y - b.y); avatares.forEach(av => { av.update(dt); av.draw(ctx); }); requestAnimationFrame(loop); }

        const input = document.getElementById('msgInput'); const history = document.getElementById('chatHistory');
        function enviarMensagem() { const txt = input.value.trim(); if(!txt) return; const div = document.createElement('div'); div.className = 'msg me'; div.innerHTML = `<strong>Eu</strong>${txt}`; history.appendChild(div); history.scrollTop = history.scrollHeight; if(myAvatar) myAvatar.falar(txt); input.value = ""; }
        document.getElementById('btnSend').addEventListener('click', enviarMensagem); if(input) input.addEventListener('keypress', (e) => { if(e.key === 'Enter') enviarMensagem(); });
        document.getElementById('btnLoja').addEventListener('click', () => alert('Loja em breve!')); document.getElementById('btnItens').addEventListener('click', () => alert('Inventário em breve!')); document.getElementById('btnCor').addEventListener('click', () => alert('Tintura em breve!'));
        document.getElementById('btnAddBot').addEventListener('click', () => { const nomes = ["Visitante", "Gamer", "Noob", "Pro"]; const nome = nomes[Math.floor(Math.random() * nomes.length)] + Math.floor(Math.random()*100); const bot = new Avatar(nome); const rect = container.getBoundingClientRect(); bot.y = rect.height - 90; bot.x = Math.random() * rect.width; avatares.push(bot); document.getElementById('online-count').innerText = avatares.length; });

        start();
    </script>
</body>
</html>
